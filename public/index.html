<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Beets Album Status</title>

<!-- 
  FIXED VERSION - 2026-02-12
  
  Changes applied:
  1. ✅ Fixed 404 errors for missing cover images - graceful fallback to placeholder icon
  2. ✅ Added lazy loading for album cover images (performance improvement)
  3. ✅ Added debouncing to search input (300ms delay for better performance)
  4. ✅ Reduced polling frequency from 2s to 5s (reduced server load)
  5. ✅ Added visibility API - pauses polling when tab is hidden
  6. ✅ Improved error handling with loading states and multiple fallback attempts
  7. ✅ Added CSS transitions for smoother image loading
  8. ✅ NEW: Added loadAndRenderLibraryStats() to fetch stats from /api/stats endpoint
  9. ✅ NEW: Library Statistics now show Formats, Genres, Years, Labels, and Missing Tracks from API
  10. ✅ NEW: All stat sections always visible with proper empty states
  
  These fixes address:
  - Log flooding from 404 errors on missing covers
  - Excessive server polling even when idle
  - Search input lag on large libraries
  - Resource usage when browser tab is not active
  - Missing data in Library Statistics section (formats, labels, missing tracks)
-->

<!-- Plyr.js Audio Player -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<style>
/* ==================== Neon Dark Theme ==================== */

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  margin: 0;
  padding: 0;
  background-color: #121212;
  color: #eee;
  overflow-x: hidden; /* prevents horizontal scroll blowout */
}

/* ==================== NAV TABS ==================== */

.nav-tabs {
  display: flex;
  background: #1a1a1a;
  border-bottom: 1px solid #333;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.nav-tab {
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 600;
  color: #888;
  cursor: pointer;
  border: none;
  background: none;
  border-bottom: 3px solid transparent;
  transition: color 0.2s, border-color 0.2s;
  margin: 0;
  border-radius: 0;
  transform: none;
}
.nav-tab:hover {
  color: #ccc;
  transform: none;
  background: none;
}
.nav-tab.active {
  color: #0ff;
  border-bottom-color: #0ff;
}

/* ==================== PAGE CONTENT ==================== */

.page {
  display: none !important;
  padding: 12px 16px;
}
.page.active {
  display: block !important;
}
#page-watcher {
  padding: 12px 16px !important;
}
#page-watcher.active {
  display: block !important;
}

/* Headings */
h1 {
  margin-top: 0;
  margin-bottom: 12px;
  color: #f0f;
}
h2 {
  margin: 0 0 8px 0;
  font-size: 16px;
  color: #0ff;
}
h3 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #0cc;
}

/* Buttons */
button {
  margin: 2px 4px 2px 0;
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
  background: #f0f;
  border: 1px solid #f0f;
  border-radius: 4px;
  color: #fff;
  transition: background 0.2s, transform 0.1s;
}
button:hover {
  background: #f0a;
  transform: scale(1.02);
}
button:disabled {
  background: #555;
  border-color: #555;
  cursor: not-allowed;
  opacity: 0.5;
}

/* Layout containers */
.top-container {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 10px;
  margin-bottom: 10px;
}
.bottom-container {
  display: grid;
  grid-template-columns: 220px 1fr 240px 280px;
  gap: 10px;
  /* grid-template-rows locked by JS after grid renders */
}

/* Boxes */
.box {
  background: #222;
  border-radius: 6px;
  padding: 8px 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  border: 1px solid #333;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}
/* Grid box: sizes ONLY to its own content. Must not stretch or clip. */
.album-grid-box {
  align-self: start;
  overflow: visible;
}

/* Stats */
.stats-box div {
  margin-bottom: 4px;
  font-size: 13px;
  color: #eee;
}

/* Library Statistics Detailed */
.library-stats-detailed-box {
  display: flex;
  flex-direction: column;
  min-height: 0;
}
.library-stats-detailed-box h2 {
  flex-shrink: 0;
  margin-bottom: 8px;
}
.library-stats-detailed {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}
.stat-category {
  background: #1a1a1a;
  border-radius: 4px;
  padding: 6px 8px;
  border: 1px solid #333;
  display: flex;
  flex-direction: column;
  min-height: 0;
}
.stat-category h3 {
  font-size: 11px;
  color: #0ff;
  margin: 0 0 6px 0;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  flex-shrink: 0;
}
.stat-list {
  font-size: 11px;
  color: #ccc;
  line-height: 1.4;
  flex: 1;
  min-height: 0;
}
.stat-list.scrollable {
  overflow-y: auto;
  max-height: 120px;
}
.stat-list::-webkit-scrollbar {
  width: 4px;
}
.stat-list::-webkit-scrollbar-track {
  background: #111;
  border-radius: 2px;
}
.stat-list::-webkit-scrollbar-thumb {
  background: #0ff;
  border-radius: 2px;
}
.stat-item {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
  border-bottom: 1px solid #222;
}
.stat-item:last-child {
  border-bottom: none;
}
.stat-name {
  color: #ccc;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
  margin-right: 8px;
}
.stat-count {
  color: #0ff;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
  flex-shrink: 0;
}
.stat-empty {
  color: #555;
  font-style: italic;
  font-size: 10px;
  padding: 4px 0;
}
.missing-album-item {
  padding: 3px 0;
  border-bottom: 1px solid #222;
  cursor: pointer;
  transition: color 0.2s;
}
.missing-album-item:hover {
  color: #0ff;
}
.missing-album-item:last-child {
  border-bottom: none;
}
.missing-album-name {
  font-size: 10px;
  color: #ccc;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.missing-album-info {
  font-size: 9px;
  color: #666;
  margin-top: 1px;
}

/* Album list */
.albums-box h2 { flex-shrink: 0; }
#search { 
  flex-shrink: 0;
  width: 100%;
  padding: 6px 8px;
  margin-bottom: 8px;
  border-radius: 4px;
  border: 1px solid #444;
  background: #111;
  color: #eee;
  font-size: 13px;
  box-sizing: border-box;
}
#album-list {
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}
.album-row {
  padding: 4px 0;
  border-bottom: 1px solid #444;
  cursor: pointer;
  transition: background 0.2s;
}
.album-row:hover {
  background: #2a2a2a;
  padding-left: 4px;
  margin-left: -4px;
  padding-right: 4px;
  margin-right: -4px;
}
.album-title {
  font-weight: 500;
  color: #fff;
  font-size: 12px;
}
.album-meta {
  font-size: 11px;
  color: #bbb;
}

/* Album grid */
.album-grid-container {
  /* no scroll   grid renders all visible items flat */
}
.album-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 6px;
  max-width: 100%;
}
.album-grid-item {
  background: #181818;
  border-radius: 2px;
  padding: 2px;
  border: 1px solid #333;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 10px;
}
.album-grid-cover {
  width: 75px;
  height: 75px;
  background: #111;
  border-radius: 2px;
  overflow: hidden;
  border: 1px solid #444;
  margin-bottom: 3px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.album-grid-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: opacity 0.3s ease;
}
.album-grid-cover img.loading {
  opacity: 0.5;
}
.album-grid-cover img.error {
  display: none;
}
.album-grid-cover .cover-placeholder {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
  color: #666;
  font-size: 32px;
  border: 1px solid #333;
  border-radius: 2px;
  z-index: 0;
}
.album-grid-cover {
  position: relative;
}
.album-grid-title {
  font-weight: 500;
  color: #fff;
  text-align: center;
  font-size: 10px;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.album-grid-meta {
  font-size: 9px;
  color: #bbb;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

/* Pagination controls */
.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #333;
  flex-shrink: 0;
}
.pagination-info { font-size: 12px; color: #999; }
.pagination-buttons { display: flex; gap: 4px; }
.pagination-buttons button { padding: 4px 8px; font-size: 12px; }

/* Recent Artists */
.artists-box h2 { flex-shrink: 0; }
#recent-artists {
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}
.artist-row {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
}
.artist-row img {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  margin-right: 6px;
  object-fit: cover;
  border: 1px solid #555;
  background: #222;
  flex-shrink: 0;
}
.artist-name { font-weight: 500; color: #eee; font-size: 11px; }
.artist-meta { font-size: 10px; color: #999; }

/* Inbox */
.inbox-box h2 { flex-shrink: 0; }
#inbox-summary {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 3px 8px;
  margin-bottom: 6px;
  flex-shrink: 0;
}
#inbox-summary div { font-size: 11px; color: #eee; }
#inbox-summary .full-width { grid-column: 1 / -1; }
.inbox-note {
  font-size: 10px;
  color: #999;
  margin-top: 6px;
  line-height: 1.3;
  flex-shrink: 0;
}
.inbox-scrollable {
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}
#inbox-tree {
  margin-top: 8px;
  font-size: 11px;
  color: #ccc;
}
#inbox-files {
  margin-top: 10px;
  font-size: 11px;
  color: #eee;
}
#inbox-files ul { padding-left: 14px; margin: 6px 0; }
#inbox-files li { margin-bottom: 2px; font-size: 10px; }
.inbox-artist { font-weight: 500; margin-top: 4px; color: #0ff; font-size: 11px; }
.inbox-albums { margin-left: 6px; }
.inbox-album { cursor: pointer; color: #ccc; margin: 2px 0; font-size: 10px; }
.inbox-album:hover { color: #fff; }

/* Loading indicator */
#loading {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #222;
  padding: 8px 10px;
  border: 1px solid #555;
  border-radius: 4px;
  z-index: 999;
  font-size: 12px;
  color: #0ff;
}

/* Debug console */
.debug-console {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #1a1a1a;
  border: 1px solid #f00;
  border-radius: 4px;
  padding: 8px;
  max-width: 400px;
  max-height: 200px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 11px;
  color: #0f0;
  z-index: 1000;
  display: none;
}
.debug-console.active {
  display: block;
}
.debug-line {
  margin: 2px 0;
  white-space: pre-wrap;
  word-break: break-all;
}
.debug-error {
  color: #f00;
}
.debug-warning {
  color: #ff0;
}

/* ==================== ALBUMS PAGE ==================== */

#page-albums {
  display: grid;
  grid-template-rows: auto 1fr auto;
  height: calc(100vh - 85px);
  gap: 12px;
}

/* Top section: Search + Album Info */
.albums-top-section {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 12px;
}

.albums-search-container {
  background: #222;
  border-radius: 8px;
  padding: 10px 12px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

#albums-search {
  width: 100%;
  padding: 7px 10px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #1a1a1a;
  color: #eee;
  font-size: 13px;
  box-sizing: border-box;
  transition: border-color 0.2s, background 0.2s;
}

#albums-search:focus {
  outline: none;
  border-color: #0ff;
  background: #222;
}

#albums-search::placeholder {
  color: #888;
}

.albums-info-placeholder {
  background: #222;
  border-radius: 8px;
  padding: 10px 12px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

.albums-current-album-info {
  display: flex;
  align-items: center;
  gap: 10px;
  min-height: 34px;
}

.albums-current-album-info.empty::after {
  content: 'Select an album to view details';
  color: #666;
  font-size: 13px;
}

.albums-current-album-cover {
  width: 50px;
  height: 50px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #444;
  background: #111;
  flex-shrink: 0;
}

.albums-current-album-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.albums-current-album-text {
  flex: 1;
  min-width: 0;
}

.albums-current-album-title {
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.albums-current-album-artist {
  font-size: 12px;
  color: #0ff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.albums-current-album-meta {
  font-size: 11px;
  color: #888;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Middle section: Sidebar + Track list */
.albums-middle-section {
  display: grid;
  grid-template-columns: 240px 1fr;
  gap: 12px;
  min-height: 0;
  overflow: hidden;
}

/* Left sidebar: recent album list */
.albums-sidebar {
  background: #222;
  border-radius: 8px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}
.albums-sidebar h2 {
  padding: 10px 12px;
  margin: 0;
  flex-shrink: 0;
  border-bottom: 1px solid #333;
}
.albums-sidebar-list {
  overflow-y: auto;
  flex: 1;
  padding: 8px;
  min-height: 0;
}
.sidebar-album-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
  border: 1px solid transparent;
}
.sidebar-album-item:hover {
  background: #2a2a2a;
}
.sidebar-album-item.active {
  background: #1e3a3a;
  border-color: #0ff3;
}
.sidebar-album-thumb {
  width: 48px;
  height: 48px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #444;
  flex-shrink: 0;
  background: #111;
}
.sidebar-album-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.sidebar-album-info {
  min-width: 0;
  flex: 1;
}
.sidebar-album-name {
  font-size: 12px;
  font-weight: 500;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sidebar-album-artist {
  font-size: 11px;
  color: #999;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sidebar-album-year {
  font-size: 10px;
  color: #666;
  flex-shrink: 0;
}

/* Right panel: tracklist */
.albums-detail-panel {
  background: #222;
  border-radius: 8px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}

/* Tracklist table */
.tracklist-container {
  overflow-y: auto;
  flex: 1;
  padding: 2px 0;
  min-height: 0;
}
.tracklist-table {
  width: 100%;
  border-collapse: collapse;
}
.tracklist-table th {
  text-align: left;
  font-size: 10px;
  color: #666;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 3px 12px;
  border-bottom: 1px solid #333;
  position: sticky;
  top: 0;
  background: #222;
}
.tracklist-table td {
  padding: 3px 12px;
  font-size: 12px;
  color: #ccc;
  border-bottom: 1px solid #2a2a2a;
}
.tracklist-table tr:last-child td {
  border-bottom: none;
}
.tracklist-table tr:hover td {
  background: #2a2a2a;
  color: #fff;
}
.track-num {
  color: #666;
  font-size: 11px;
  width: 28px;
}
.track-title {
  font-weight: 500;
  color: #eee;
}
.track-duration {
  color: #777;
  text-align: right;
  font-size: 11px;
  font-variant-numeric: tabular-nums;
}
.tracklist-table tbody tr {
  cursor: pointer;
  transition: background 0.15s;
}
.tracklist-table tbody tr:hover {
  background: #2a2a2a !important;
}
.tracklist-table tbody tr.playing {
  background: #1a3a3a !important;
}
.tracklist-table tbody tr.playing .track-title {
  color: #0ff;
}

/* Bottom section: Music Player */
.albums-bottom-section {
  min-height: 100px;
  max-height: 140px;
}

/* Audio Player Box */
.audio-player-box {
  background: #222;
  border-radius: 8px;
  padding: 10px 12px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  height: 100%;
  display: flex;
  flex-direction: column;
}
.audio-player-box h3 {
  margin: 0 0 6px 0;
  font-size: 12px;
  color: #0ff;
  font-weight: 600;
}
.now-playing-info {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.now-playing-cover {
  width: 45px;
  height: 45px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #444;
  background: #111;
  flex-shrink: 0;
}
.now-playing-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.now-playing-text {
  flex: 1;
  min-width: 0;
}
.now-playing-track {
  font-size: 12px;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}
.now-playing-artist {
  font-size: 11px;
  color: #0ff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.now-playing-album {
  font-size: 10px;
  color: #888;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Plyr.js Custom Styling */
.plyr--audio .plyr__controls {
  background: #222;
  border-radius: 6px;
  padding: 12px;
  border: 1px solid #333;
}
.plyr__control--overlaid {
  background: #f0f;
}
.plyr__control--overlaid:hover {
  background: #f0a;
}
.plyr__control:hover {
  background: #f0f;
}
.plyr--audio .plyr__control.plyr__tab-focus,
.plyr--audio .plyr__control:hover,
.plyr--audio .plyr__control[aria-expanded=true] {
  background: #f0f;
  color: #fff;
}
.plyr--full-ui input[type=range] {
  color: #f0f;
}
.plyr__menu__container .plyr__control[role=menuitemradio][aria-checked=true]::before {
  background: #f0f;
}
.plyr--audio .plyr__progress__buffer {
  color: rgba(240, 0, 240, 0.25);
}

/* Empty state for audio player */
.audio-player-empty {
  padding: 24px;
  text-align: center;
  color: #666;
  font-size: 13px;
}

/* Empty state */
.albums-detail-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #555;
  font-size: 14px;
  gap: 8px;
}
.albums-detail-empty .empty-icon {
  font-size: 36px;
  opacity: 0.4;
}

/* ==================== WATCHER PAGE ==================== */

.watcher-page-layout {
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: calc(100vh - 85px);
}

/* ==================== PLAYLIST BUILDER PAGE ==================== */

.playlist-page-layout {
  display: grid;
  grid-template-rows: auto 1fr;
  height: calc(100vh - 85px);
  gap: 16px;
}

.playlist-upload-section {
  background: #222;
  border-radius: 8px;
  padding: 20px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

.playlist-upload-section h2 {
  margin: 0 0 16px 0;
  color: #0ff;
  font-size: 18px;
}

.playlist-upload-zone {
  border: 2px dashed #555;
  border-radius: 8px;
  padding: 40px;
  text-align: center;
  background: #1a1a1a;
  cursor: pointer;
  transition: all 0.3s;
}

.playlist-upload-zone:hover {
  border-color: #0ff;
  background: #222;
}

.playlist-upload-zone.dragover {
  border-color: #f0f;
  background: #2a1a2a;
}

.playlist-upload-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.playlist-upload-text {
  font-size: 16px;
  color: #ccc;
  margin-bottom: 8px;
}

.playlist-upload-hint {
  font-size: 12px;
  color: #666;
}

.playlist-file-input {
  display: none;
}

.playlist-results-section {
  background: #222;
  border-radius: 8px;
  padding: 20px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.playlist-results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-shrink: 0;
}

.playlist-results-header h2 {
  margin: 0;
  color: #0ff;
  font-size: 18px;
}

.playlist-stats {
  display: flex;
  gap: 24px;
  font-size: 13px;
  color: #ccc;
}

.playlist-stat {
  display: flex;
  align-items: center;
  gap: 6px;
}

.playlist-stat-value {
  font-weight: 700;
  color: #0ff;
  font-size: 16px;
}

.playlist-save-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 16px;
  flex-shrink: 0;
}

.playlist-name-input {
  flex: 1;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #1a1a1a;
  color: #eee;
  font-size: 13px;
}

.playlist-name-input:focus {
  outline: none;
  border-color: #0ff;
}

.playlist-tracks-container {
  flex: 1;
  overflow-y: auto;
  background: #111;
  border-radius: 6px;
  padding: 12px;
  border: 1px solid #333;
  min-height: 0;
}

.playlist-track-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 12px;
  border-bottom: 1px solid #222;
  transition: background 0.15s;
}

.playlist-track-item:hover {
  background: #1a1a1a;
}

.playlist-track-item:last-child {
  border-bottom: none;
}

.playlist-track-number {
  font-size: 12px;
  color: #666;
  min-width: 30px;
  text-align: right;
}

.playlist-track-info {
  flex: 1;
  min-width: 0;
}

.playlist-track-title {
  font-size: 13px;
  font-weight: 500;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.playlist-track-meta {
  font-size: 11px;
  color: #888;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.playlist-track-status {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  background: #1a3a1a;
  color: #0f0;
  flex-shrink: 0;
}

.playlist-track-status.unmatched {
  background: #3a1a1a;
  color: #f88;
}

.playlist-empty {
  text-align: center;
  padding: 40px;
  color: #666;
  font-size: 14px;
}

/* ==================== WATCHER PAGE (CONTINUED) ==================== */

.watcher-stats-section {
  background: #222;
  border-radius: 8px;
  padding: 16px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  flex-shrink: 0;
}

.watcher-stats-section h2 {
  margin: 0 0 16px 0;
  color: #0ff;
  font-size: 18px;
}

.watcher-stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
}

.watcher-stat-card {
  background: #1a1a1a;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #333;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.watcher-stat-card .watcher-stat-value {
  font-size: 42px;
  font-weight: 700;
  color: #0ff;
  display: block;
  line-height: 1;
}

.watcher-stat-card .watcher-stat-label {
  font-size: 14px;
  color: #fff;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.watcher-stat-card .watcher-stat-description {
  font-size: 12px;
  color: #888;
}

.watcher-logs-section {
  background: #222;
  border-radius: 8px;
  padding: 16px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.watcher-logs-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-shrink: 0;
}

.watcher-logs-header h2 {
  margin: 0;
  color: #0ff;
  font-size: 18px;
}

.watcher-logs-section .log-controls {
  display: flex;
  gap: 8px;
}

.watcher-logs-section .log-controls button {
  font-size: 12px;
  padding: 6px 12px;
}

.watcher-logs-section .watcher-logs-container {
  flex: 1;
  overflow-y: auto;
  background: #111;
  border-radius: 6px;
  padding: 12px;
  border: 1px solid #333;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.6;
  min-height: 0;
}

/* Shared log entry styles (for watcher logs and debug console) */
.log-entry {
  padding: 2px 0;
  border-bottom: 1px solid #222;
}
.log-entry:last-child {
  border-bottom: none;
}
.log-timestamp {
  color: #666;
  margin-right: 8px;
}
.log-level {
  font-weight: 600;
  margin-right: 8px;
  text-transform: uppercase;
}
.log-level.info {
  color: #0ff;
}
.log-level.warning {
  color: #ff0;
}
.log-level.error {
  color: #f00;
}
.log-level.success {
  color: #0f0;
}
.log-message {
  color: #ccc;
}
.log-empty {
  color: #555;
  text-align: center;
  padding: 20px;
  font-style: italic;
}

/* =============================================================================
   SLSKD SEARCH MODAL - Add to index.html <style> section
   ============================================================================= */

/* Search Modal */
.slskd-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.slskd-modal.active {
  display: flex;
}

.slskd-modal-content {
  background: #1a1a1a;
  border: 1px solid #0ff;
  border-radius: 8px;
  width: 90%;
  max-width: 900px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
}

.slskd-modal-header {
  padding: 16px 20px;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.slskd-modal-header h3 {
  margin: 0;
  color: #0ff;
  font-size: 18px;
}

.slskd-modal-close {
  background: none;
  border: none;
  color: #f00;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  line-height: 32px;
  text-align: center;
}

.slskd-modal-close:hover {
  color: #f55;
  background: #400;
  border-radius: 4px;
}

.slskd-modal-body {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

.slskd-search-info {
  background: #222;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 16px;
  border-left: 3px solid #0ff;
}

.slskd-search-info p {
  margin: 4px 0;
  font-size: 13px;
  color: #ccc;
}

.slskd-search-info strong {
  color: #0ff;
}

.slskd-results-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.slskd-result-item {
  background: #222;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}

.slskd-result-item:hover {
  background: #2a2a2a;
  border-color: #0ff;
}

.slskd-result-info {
  flex: 1;
  min-width: 0;
}

.slskd-result-filename {
  font-size: 13px;
  font-weight: 500;
  color: #fff;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.slskd-result-meta {
  font-size: 11px;
  color: #888;
  display: flex;
  gap: 16px;
}

.slskd-result-meta span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.slskd-result-quality {
  color: #0f0;
  font-weight: 600;
}

.slskd-download-btn {
  background: #0ff;
  color: #000;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  margin-left: 12px;
}

.slskd-download-btn:hover {
  background: #0cc;
  transform: scale(1.05);
}

.slskd-download-btn:disabled {
  background: #555;
  color: #888;
  cursor: not-allowed;
  opacity: 0.5;
}

.slskd-no-results {
  text-align: center;
  padding: 40px;
  color: #666;
  font-size: 14px;
}

.slskd-loading {
  text-align: center;
  padding: 40px;
  color: #0ff;
  font-size: 14px;
}

.slskd-loading::after {
  content: '...';
  animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60%, 100% { content: '...'; }
}

.search-missing-btn {
  background: #0ff;
  color: #000;
  border: none;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  margin-left: 6px;
  transition: all 0.2s;
}

.search-missing-btn:hover {
  background: #0cc;
  transform: scale(1.05);
}

</style>
</head>
<body>

<!-- NAV TABS -->
<div class="nav-tabs">
  <button class="nav-tab active" data-page="main">Main</button>
  <button class="nav-tab" data-page="albums">Albums</button>
  <button class="nav-tab" data-page="playlist">Playlist</button>
  <button class="nav-tab" data-page="watcher">Watcher</button>
  <button class="nav-tab" id="debug-toggle" style="margin-left: auto;">Debug</button>
</div>

<!-- Loading indicator -->
<div id="loading" style="display:none;">Loading...</div>

<!-- Debug console -->
<div id="debug-console" class="debug-console"></div>

<!-- ==================== MAIN PAGE ==================== -->
<div class="page active" id="page-main">

  <!-- TOP: Stats + Recently Added -->
  <div class="top-container">
    <div class="box stats-box">
      <h2>Library Stats</h2>
      <div id="stats">
        <div>Tracks: �</div>
        <div>Albums: �</div>
        <div>Artists: �</div>
        <div>Total time: �</div>
        <div>Total size: �</div>
      </div>
    </div>
    
    <div class="box library-stats-detailed-box">
      <h2>Library Statistics</h2>
      <div id="library-stats-detailed" class="library-stats-detailed">
        <div class="stat-category">
          <h3>Formats</h3>
          <div id="format-stats" class="stat-list"></div>
        </div>
        <div class="stat-category">
          <h3>Top Genres</h3>
          <div id="genre-stats" class="stat-list scrollable"></div>
        </div>
        <div class="stat-category">
          <h3>Years</h3>
          <div id="year-stats" class="stat-list scrollable"></div>
        </div>
        <div class="stat-category">
          <h3>Labels</h3>
          <div id="label-stats" class="stat-list scrollable"></div>
        </div>
        <div class="stat-category">
          <h3>Missing Tracks</h3>
          <div id="missing-tracks-stats" class="stat-list scrollable"></div>
        </div>
      </div>
    </div>
  </div>


  <!-- BOTTOM: list, grid, artists, inbox -->
  <div class="bottom-container">
    <div class="box albums-box">
      <h2>All Albums</h2>
      <input id="search" type="text" placeholder="Search albums or artists?" />
      <div id="album-list"></div>
    </div>

    <div class="box album-grid-box">
      <h2>Album Grid</h2>
      <div class="album-grid-container">
        <div id="album-grid" class="album-grid"></div>
      </div>
      <div class="pagination" id="grid-pagination">
        <div class="pagination-info" id="grid-page-info"></div>
        <div class="pagination-buttons">
          <button id="grid-load-more">Load More</button>
        </div>
      </div>
    </div>

    <div class="box artists-box">
      <h2>Recent Artists</h2>
      <div id="recent-artists"></div>
    </div>

    <div class="box inbox-box">
      <h2>Inbox</h2>
      <div id="inbox-summary">
        <div>Tracks: <span id="inbox-tracks">Loading </span></div>
        <div>Artists: <span id="inbox-artists">Loading </span></div>
        <div>Albums: <span id="inbox-albums">Loading </span></div>
        <div class="full-width">Total time: <span id="inbox-time">Loading </span></div>
        <div class="full-width">Total size: <span id="inbox-size">Loading </span></div>
      </div>
      <div class="inbox-note">Expandable folders<br />Artist   Albums   Files</div>
      <div class="inbox-scrollable">
        <div id="inbox-tree"></div>
        <div id="inbox-files"></div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== ALBUMS PAGE ==================== -->
<div class="page" id="page-albums">
  <div class="albums-top-section">
    <div class="albums-search-container">
      <input id="albums-search" type="text" placeholder="Search albums or artists?" />
    </div>
    <div class="albums-info-placeholder">
      <div id="albums-current-info" class="albums-current-album-info"></div>
    </div>
  </div>
  
  <div class="albums-middle-section">
    <div class="albums-sidebar">
      <h2>Recent Albums</h2>
      <div class="albums-sidebar-list" id="albums-sidebar-list"></div>
    </div>
    
    <div class="albums-detail-panel" id="albums-detail-panel">
      <div class="albums-detail-empty">
        <div class="empty-icon">??</div>
        <div>Select an album to view its tracks</div>
      </div>
    </div>
  </div>
  
  <div class="albums-bottom-section">
    <div class="audio-player-box" id="audio-player-box">
      <h3>Now Playing</h3>
      <div class="now-playing-info" id="now-playing-info">
        <div class="audio-player-empty">Click a track to start playing</div>
      </div>
      <audio id="audio-player" controls></audio>
    </div>
  </div>
</div>

<!-- ==================== PLAYLIST BUILDER PAGE ==================== -->
<div class="page" id="page-playlist">
  <div class="playlist-page-layout">
    <div class="playlist-upload-section">
      <h2>?? Playlist Builder for Volumio</h2>
      
      <div class="playlist-upload-zone" id="upload-zone">
        <div class="playlist-upload-icon">??</div>
        <div class="playlist-upload-text">Drop your CSV file here or click to browse</div>
        <div class="playlist-upload-hint">Supports Spotify, Apple Music, or any CSV with track/artist/album columns</div>
        <input type="file" id="csv-file-input" class="playlist-file-input" accept=".csv" />
      </div>
    </div>
    
    <div class="playlist-results-section" id="playlist-results" style="display: none;">
      <div class="playlist-results-header">
        <h2>Playlist Results</h2>
        <div class="playlist-stats">
          <div class="playlist-stat">
            <span>Total:</span>
            <span class="playlist-stat-value" id="playlist-total">0</span>
          </div>
          <div class="playlist-stat">
            <span>Matched:</span>
            <span class="playlist-stat-value" id="playlist-matched">0</span>
          </div>
          <div class="playlist-stat">
            <span>Unmatched:</span>
            <span class="playlist-stat-value" style="color: #f88;" id="playlist-unmatched">0</span>
          </div>
        </div>
      </div>
      
      <div class="playlist-save-controls">
        <input 
          type="text" 
          id="playlist-name-input" 
          class="playlist-name-input" 
          placeholder="Enter playlist name..."
        />
        <button id="save-playlist-btn">Save Playlist</button>
        <button id="clear-playlist-btn">Clear</button>
      </div>
      
      <div class="playlist-tracks-container" id="playlist-tracks">
        <div class="playlist-empty">No tracks loaded</div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== WATCHER PAGE ==================== -->
<div class="page" id="page-watcher">
  <div class="watcher-page-layout">
    <div class="watcher-stats-section">
      <h2>Queue Status</h2>
      <div class="watcher-stats-grid">
        <div class="watcher-stat-card">
          <span class="watcher-stat-value" id="inbox-queue-count">0</span>
          <span class="watcher-stat-label">Inbox Queue</span>
          <span class="watcher-stat-description">Pending imports from inbox</span>
        </div>
        <div class="watcher-stat-card">
          <span class="watcher-stat-value" id="library-queue-count">0</span>
          <span class="watcher-stat-label">Library Queue</span>
          <span class="watcher-stat-description">Albums being processed</span>
        </div>
        <div class="watcher-stat-card">
          <span class="watcher-stat-value" id="cover-queue-count">0</span>
          <span class="watcher-stat-label">Cover Queue</span>
          <span class="watcher-stat-description">Cover art downloads</span>
        </div>
        <div class="watcher-stat-card">
          <span class="watcher-stat-value" id="lyrics-queue-count">0</span>
          <span class="watcher-stat-label">Lyrics Queue</span>
          <span class="watcher-stat-description">Lyrics fetching (rate-limited)</span>
        </div>
      </div>
    </div>
    
    <div class="watcher-logs-section">
      <div class="watcher-logs-header">
        <h2>Activity Log</h2>
        <div class="log-controls">
          <button id="clear-logs-btn">Clear Logs</button>
          <button id="pause-logs-btn">Pause</button>
        </div>
      </div>
      <div class="watcher-logs-container" id="watcher-logs"></div>
    </div>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
// ==================== DEBUG UTILITIES ====================

let debugEnabled = false;
const debugLines = [];
const MAX_DEBUG_LINES = 50;

function debugLog(message, type = 'info') {
  console.log(`[${type.toUpperCase()}]`, message);
  
  if (debugEnabled) {
    const line = document.createElement('div');
    line.className = 'debug-line';
    if (type === 'error') line.classList.add('debug-error');
    if (type === 'warning') line.classList.add('debug-warning');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    
    const console = document.getElementById('debug-console');
    console.insertBefore(line, console.firstChild);
    
    debugLines.push(line);
    if (debugLines.length > MAX_DEBUG_LINES) {
      const removed = debugLines.shift();
      removed.remove();
    }
  }
}

function toggleDebug() {
  debugEnabled = !debugEnabled;
  const console = document.getElementById('debug-console');
  console.classList.toggle('active', debugEnabled);
  debugLog('Debug console ' + (debugEnabled ? 'enabled' : 'disabled'));
}

document.getElementById('debug-toggle').addEventListener('click', toggleDebug);

// Keyboard shortcut: Ctrl+D or Cmd+D
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
    e.preventDefault();
    toggleDebug();
  }
});

// ==================== WATCHER LOGS ====================

const watcherLogs = [];
const MAX_LOG_ENTRIES = 100;
let logsPaused = false;

function addWatcherLog(level, message) {
  if (logsPaused) return;
  
  const timestamp = new Date().toLocaleTimeString();
  const entry = { timestamp, level, message };
  watcherLogs.unshift(entry);
  
  if (watcherLogs.length > MAX_LOG_ENTRIES) {
    watcherLogs.pop();
  }
  
  renderWatcherLogs();
}

function renderWatcherLogs() {
  const container = document.getElementById('watcher-logs');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (watcherLogs.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'log-empty';
    empty.textContent = 'No activity yet...';
    container.appendChild(empty);
    return;
  }
  
  watcherLogs.forEach(entry => {
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    
    const timestamp = document.createElement('span');
    timestamp.className = 'log-timestamp';
    timestamp.textContent = entry.timestamp;
    
    const level = document.createElement('span');
    level.className = `log-level ${entry.level}`;
    level.textContent = entry.level;
    
    const message = document.createElement('span');
    message.className = 'log-message';
    message.textContent = entry.message;
    
    logEntry.appendChild(timestamp);
    logEntry.appendChild(level);
    logEntry.appendChild(message);
    container.appendChild(logEntry);
  });
  
  // Auto-scroll to bottom (most recent)
  if (!logsPaused) {
    container.scrollTop = 0;
  }
}

function clearWatcherLogs() {
  watcherLogs.length = 0;
  renderWatcherLogs();
}

function toggleLogsPause() {
  logsPaused = !logsPaused;
  const btn = document.getElementById('pause-logs-btn');
  btn.textContent = logsPaused ? 'Resume' : 'Pause';
}

// ==================== WATCHER STATUS POLLING ====================

async function updateWatcherStatus() {
  try {
    const res = await fetch('/api/watcher/status');
    if (!res.ok) return;
    
    const data = await res.json();
    
    document.getElementById('inbox-queue-count').textContent = data.inbox_queue || 0;
    document.getElementById('library-queue-count').textContent = data.library_queue || 0;
    document.getElementById('cover-queue-count').textContent = data.cover_queue || 0;
    document.getElementById('lyrics-queue-count').textContent = data.lyrics_queue || 0;
    
    // Add new log entries
    if (data.recent_logs && Array.isArray(data.recent_logs)) {
      data.recent_logs.forEach(log => {
        addWatcherLog(log.level || 'info', log.message || '');
      });
    }
  } catch (e) {
    console.error('Failed to update watcher status:', e);
  }
}

// ==================== UTILITIES ====================

function showLoading() { 
  document.getElementById("loading").style.display = "block"; 
}

function hideLoading() { 
  document.getElementById("loading").style.display = "none"; 
}

function _safe(v) { 
  return (v === undefined || v === null || v === "") ? "0" : String(v); 
}

function fmtTimestamp(epoch) {
  if (!epoch || epoch === 0) return "-";
  const d = new Date(epoch * 1000);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function formatCompactTime(timeStr) {
  if (!timeStr || timeStr === "0 seconds" || timeStr === "-" || timeStr === "0") return "0 hrs";

  const weekMatch = timeStr.match(/(\d+)\s*week/);
  const dayMatch = timeStr.match(/(\d+)\s*day/);
  const hourMatch = timeStr.match(/(\d+)\s*hour/);
  const minMatch = timeStr.match(/(\d+)\s*minute/);
  const secMatch = timeStr.match(/(\d+)\s*second/);

  const weeks = weekMatch ? parseInt(weekMatch[1]) : 0;
  const days = dayMatch ? parseInt(dayMatch[1]) : 0;
  const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
  const minutes = minMatch ? parseInt(minMatch[1]) : 0;
  const seconds = secMatch ? parseInt(secMatch[1]) : 0;

  const totalHours = (weeks*7*24) + (days*24) + hours + (minutes/60) + (seconds/3600);

  if (totalHours >= 24) return (totalHours/24).toFixed(1) + " days";
  if (totalHours >= 1) return totalHours.toFixed(1) + " hrs";
  if (minutes >= 1) return minutes + " min";
  return seconds + " sec";
}

function formatTrackDuration(seconds) {
  if (!seconds && seconds !== 0) return "-";
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}:${String(s).padStart(2, "0")}`;
}

// ==================== FIXED COVER URL LOGIC ====================

function coverUrlFor(album) {
  const folder =
    album?.folder ||
    album?.path ||
    album?.directory ||
    album?.example_path;

  if (!folder) return "/static/placeholder.jpg";

  const clean = folder.replace(/\/$/, "");

  return `/music/library${clean}/cover.jpg`;
}

// ==================== NAVIGATION ====================

const tabs = document.querySelectorAll(".nav-tab");
const pages = { 
  main: document.getElementById("page-main"), 
  albums: document.getElementById("page-albums"),
  playlist: document.getElementById("page-playlist"),
  watcher: document.getElementById("page-watcher")
};

tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.id === 'debug-toggle') return;
    
    const pageName = tab.dataset.page;
    if (!pageName) {
      console.error('Tab missing data-page attribute:', tab);
      return;
    }
    
    if (!pages[pageName]) {
      console.error('Page not found for:', pageName);
      debugLog(`Page not found: ${pageName}`, 'error');
      return;
    }
    
    // Remove active class from all tabs
    tabs.forEach(t => {
      if (t.id !== 'debug-toggle') {
        t.classList.remove("active");
      }
    });
    
    // Remove active class from all pages
    Object.values(pages).forEach(p => {
      if (p) p.classList.remove("active");
    });
    
    // Add active class to clicked tab and corresponding page
    tab.classList.add("active");
    pages[pageName].classList.add("active");
    
    debugLog(`Switched to page: ${pageName}`);
  });
});

// ==================== GLOBAL STATE ====================

let allAlbums = [];
let filteredAlbums = [];
let filteredSidebarAlbums = [];
const PAGE_SIZE = 25;
let gridItemsToShow = PAGE_SIZE;
let currentSelectedAlbum = null;

// Audio player state
let player = null;
let currentPlaylist = [];
let currentTrackIndex = -1;
let currentAlbumData = null;

// ==================== STATS ====================

async function loadStats() {
  showLoading();
  try {
    const res = await fetch("/api/stats");
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    const statsDiv = document.getElementById("stats");
    statsDiv.innerHTML = "";
    const add = (label, value) => { const d = document.createElement("div"); d.textContent = label + ": " + value; statsDiv.appendChild(d); };
    add("Tracks", data.tracks ?? "0");
    add("Albums", data.albums ?? "0");
    add("Artists", data.album_artists ?? "0");
    add("Total time", data.total_time ?? "0");
    add("Total size", data.total_size ?? "0");
  } catch (e) { 
    console.error("loadStats error", e); 
  }
  finally { hideLoading(); }
}

// ==================== DETAILED LIBRARY STATS ====================

async function loadAndRenderLibraryStats() {
  try {
    const res = await fetch("/api/stats");
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    
    // Render Formats
    const formatContainer = document.getElementById('format-stats');
    if (formatContainer) {
      formatContainer.innerHTML = '';
      if (data.formats && Object.keys(data.formats).length > 0) {
        renderStatCategory('format-stats', data.formats, 'tracks');
      } else {
        formatContainer.innerHTML = '<div class="stat-empty">No data</div>';
      }
    }
    
    // Render Top Genres
    const genreContainer = document.getElementById('genre-stats');
    if (genreContainer) {
      genreContainer.innerHTML = '';
      if (data.top_genres && Object.keys(data.top_genres).length > 0) {
        renderStatCategory('genre-stats', data.top_genres, 'albums', 20);
      } else {
        genreContainer.innerHTML = '<div class="stat-empty">No data</div>';
      }
    }
    
    // Render Years
    const yearContainer = document.getElementById('year-stats');
    if (yearContainer) {
      yearContainer.innerHTML = '';
      if (data.years && Object.keys(data.years).length > 0) {
        renderStatCategory('year-stats', data.years, 'albums', null, true);
      } else {
        yearContainer.innerHTML = '<div class="stat-empty">No data</div>';
      }
    }
    
    // Render Labels - ALWAYS SHOW THIS SECTION
    const labelContainer = document.getElementById('label-stats');
    if (labelContainer) {
      labelContainer.innerHTML = '';
      if (data.labels && Object.keys(data.labels).length > 0) {
        renderStatCategory('label-stats', data.labels, 'albums', 15);
      } else {
        labelContainer.innerHTML = '<div class="stat-empty">No data available</div>';
      }
    }
    
    // Render Missing Tracks - ALWAYS SHOW THIS SECTION
    const missingContainer = document.getElementById('missing-tracks-stats');
    if (missingContainer) {
      missingContainer.innerHTML = '';
      
      if (data.missing_tracks_count === -1) {
        const item = document.createElement('div');
        item.className = 'stat-empty';
        item.textContent = 'Calculating...';
        missingContainer.appendChild(item);
      } else if (data.missing_tracks_count > 0) {
        const item = document.createElement('div');
        item.className = 'stat-item';
        
        const nameEl = document.createElement('div');
        nameEl.className = 'stat-name';
        nameEl.textContent = 'Incomplete albums';
        
        const countEl = document.createElement('div');
        countEl.className = 'stat-count';
        countEl.textContent = data.missing_tracks_count;
        
        item.appendChild(nameEl);
        item.appendChild(countEl);
        missingContainer.appendChild(item);
      } else {
        const item = document.createElement('div');
        item.className = 'stat-empty';
        item.textContent = '✓ All complete';
        item.style.color = '#0f0';
        missingContainer.appendChild(item);
      }
    }
    
  } catch (e) {
    console.error("loadAndRenderLibraryStats error", e);
    
    ['format-stats', 'genre-stats', 'year-stats', 'label-stats', 'missing-tracks-stats'].forEach(id => {
      const container = document.getElementById(id);
      if (container) {
        container.innerHTML = '<div class="stat-empty" style="color: #f00;">Error loading</div>';
      }
    });
  }
}


// ==================== INBOX ====================

async function loadInboxStats() {
  try {
    const res = await fetch("/api/inbox/stats");
    
    if (!res.ok) {
      console.error("Inbox stats fetch failed:", res.status);
      throw new Error("status " + res.status);
    }
    
    const data = await res.json();
    
    const tracks = data.tracks !== undefined && data.tracks !== null ? String(data.tracks) : "0";
    const artists = data.artists !== undefined && data.artists !== null ? String(data.artists) : "0";
    const albums = data.albums !== undefined && data.albums !== null ? String(data.albums) : "0";
    const time = data.total_time || "0 seconds";
    const size = data.total_size || "0 B";
    
    document.getElementById("inbox-tracks").textContent = tracks;
    document.getElementById("inbox-artists").textContent = artists;
    document.getElementById("inbox-albums").textContent = albums;
    document.getElementById("inbox-time").textContent = formatCompactTime(time);
    document.getElementById("inbox-size").textContent = size;
  } catch (err) { 
    console.error("Error loading inbox stats:", err); 
    document.getElementById("inbox-tracks").textContent = "Error";
    document.getElementById("inbox-artists").textContent = "Error";
    document.getElementById("inbox-albums").textContent = "Error";
    document.getElementById("inbox-time").textContent = "Error";
    document.getElementById("inbox-size").textContent = "Error";
  }
}

function renderInboxTree(tree) {
  const container = document.getElementById("inbox-tree");
  container.innerHTML = "";
  if (!tree || Object.keys(tree).length === 0) {
    const p = document.createElement("div"); p.style.color = "#666"; p.textContent = "No inbox folders found.";
    container.appendChild(p); return;
  }
  for (const artist of Object.keys(tree).sort((a,b) => a.localeCompare(b))) {
    const artistDiv = document.createElement("div"); artistDiv.className = "inbox-artist"; artistDiv.textContent = artist;
    const albumList = document.createElement("div"); albumList.className = "inbox-albums";
    (tree[artist] || []).forEach((album) => {
      const albumDiv = document.createElement("div"); albumDiv.className = "inbox-album";
      // Handle both string and object formats
      const albumName = typeof album === 'string' ? album : album.name;
      const trackCount = typeof album === 'object' && album.tracks ? ` (${album.tracks} tracks)` : '';
      albumDiv.textContent = "� " + albumName + trackCount; 
      albumDiv.title = albumName;
      albumDiv.onclick = () => loadInboxFolder(artist, albumName);
      albumList.appendChild(albumDiv);
    });
    container.appendChild(artistDiv); container.appendChild(albumList);
  }
}

async function loadInboxTree() {
  try {
    const res = await fetch("/api/inbox/tree");
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    renderInboxTree(data.folders || data);
  } catch (err) { 
    console.error("Error loading inbox tree:", err); 
    renderInboxTree({}); 
  }
}

async function loadInboxFolder(artist, album) {
  try {
    const url = `/api/inbox/folder?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    renderInboxFiles(artist, album, data.tracks);
  } catch (err) { console.error("loadInboxFolder:", err); renderInboxFiles(artist, album, []); }
}

function renderInboxFiles(artist, album, tracks) {
  const container = document.getElementById("inbox-files");
  container.innerHTML = "";
  const title = document.createElement("h3"); title.textContent = `${artist} � ${album}`; container.appendChild(title);
  if (!tracks || tracks.length === 0) {
    const p = document.createElement("div"); p.style.color = "#666"; p.textContent = "No files found."; container.appendChild(p); return;
  }
  const list = document.createElement("ul");
  tracks.forEach(track => { 
    const li = document.createElement("li"); 
    // Handle both string filenames and track objects
    const filename = typeof track === 'string' ? track : track.filename;
    const size = track.size ? ` (${(track.size / 1024 / 1024).toFixed(2)} MB)` : '';
    const duration = track.duration ? ` - ${formatTrackDuration(track.duration)}` : '';
    li.textContent = filename + size + duration;
    list.appendChild(li); 
  });
  container.appendChild(list);
}

// ==================== ALBUMS (MAIN PAGE) ====================

async function loadAlbums() {
  showLoading();
  try {
    const res = await fetch("/data/albums.json");
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    
    debugLog(`Loaded ${data.length} albums from albums.json`);
    
    if (data.length > 0) {
      debugLog(`Sample album keys: ${Object.keys(data[0]).join(', ')}`);
      if (data[0].tracks && data[0].tracks.length > 0) {
        debugLog(`Sample track keys: ${Object.keys(data[0].tracks[0]).join(', ')}`);
      }
    }
    
    allAlbums = Array.isArray(data) ? data.sort((a,b) => {
      const aTime = a._mtime || a.mtime || a.added || 0;
      const bTime = b._mtime || b.mtime || b.added || 0;
      return bTime - aTime;
    }) : [];
    filteredAlbums = allAlbums.slice();
    filteredSidebarAlbums = allAlbums.slice();
    gridItemsToShow = PAGE_SIZE;
    renderAlbums();
    renderAlbumGrid();
    // Use API stats instead of calculating from albums
    // renderLibraryStatistics(allAlbums);
    loadAndRenderLibraryStats();
    renderRecentArtists(allAlbums);
    renderAlbumsSidebar();
  } catch (e) { 
    console.error("loadAlbums error", e);
    debugLog(`Error loading albums: ${e.message}`, 'error');
  }
  finally { hideLoading(); }
}

function renderAlbums() {
  const list = document.getElementById("album-list");
  if (!list) return;
  list.innerHTML = "";
  for (const a of filteredAlbums) {
    const row = document.createElement("div"); 
    row.className = "album-row";
    
    // FIXED: Add click handler to select album
    row.onclick = () => selectAlbum(allAlbums.indexOf(a));
    row.style.cursor = "pointer";
    
    const title = document.createElement("div"); 
    title.className = "album-title"; 
    title.textContent = a.album || "(Unknown album)";
    
    const meta = document.createElement("div"); 
    meta.className = "album-meta";
    const bits = [];
    if (a.albumartist) bits.push(a.albumartist); else if (a.artist) bits.push(a.artist);
    if (a.year) bits.push(a.year);
    meta.textContent = bits.join("   ") || "-";
    
    row.appendChild(title); 
    row.appendChild(meta); 
    list.appendChild(row);
  }
}

function renderAlbumGrid() {
  const grid = document.getElementById("album-grid");
  if (!grid) return;
  grid.innerHTML = "";
  const albums = filteredAlbums;
  const itemsToDisplay = Math.min(gridItemsToShow, albums.length);
  
  albums.slice(0, itemsToDisplay).forEach((a) => {
    const item = document.createElement("div"); 
    item.className = "album-grid-item";
    
    const coverDiv = document.createElement("div"); 
    coverDiv.className = "album-grid-cover";
    
    // Add placeholder first
    const placeholder = document.createElement("div");
    placeholder.className = "cover-placeholder";
    placeholder.textContent = "♪";
    placeholder.title = "Loading cover...";
    coverDiv.appendChild(placeholder);
    
    // Create and configure image
    const img = document.createElement("img"); 
    img.src = coverUrlFor(a);
    img.loading = "lazy"; // Native lazy loading for performance
    img.className = "loading";
    
    // Success handler
    img.onload = function() {
      this.classList.remove("loading");
      this.style.zIndex = "1";
    };
    
    // Error handler with better fallback
    img.onerror = function() {
      if (!this.dataset.fallbackAttempted) {
        // First attempt: try placeholder
        this.dataset.fallbackAttempted = "true";
        this.src = "/static/placeholder.jpg";
      } else {
        // Final fallback: hide image and show placeholder
        this.classList.add("error");
        placeholder.textContent = "♪";
        placeholder.title = "Cover art not available";
      }
    };
    
    coverDiv.appendChild(img);
    
    const title = document.createElement("div"); 
    title.className = "album-grid-title"; 
    title.textContent = a.album || "(Unknown album)";
    title.title = a.album || "(Unknown album)"; // Tooltip for long names
    
    const meta = document.createElement("div"); 
    meta.className = "album-grid-meta";
    const bits = [];
    if (a.albumartist) bits.push(a.albumartist); 
    else if (a.artist) bits.push(a.artist);
    if (a.year) bits.push(a.year);
    meta.textContent = bits.join("   ") || "-";
    
    item.appendChild(coverDiv); 
    item.appendChild(title); 
    item.appendChild(meta); 
    grid.appendChild(item);
  });
  
  const pageInfo = document.getElementById("grid-page-info");
  if (pageInfo) pageInfo.textContent = `Showing ${itemsToDisplay} of ${albums.length}`;
  
  const btn = document.getElementById("grid-load-more");
  if (btn) { 
    btn.disabled = itemsToDisplay >= albums.length; 
    btn.textContent = btn.disabled ? "All Loaded" : "Load More"; 
  }

  requestAnimationFrame(() => {
    const gridBox = document.querySelector(".album-grid-box");
    const container = document.querySelector(".bottom-container");
    if (gridBox && container) {
      container.style.gridTemplateRows = gridBox.getBoundingClientRect().height + "px";
    }
  });
}

function filterAlbums() {
  const q = (document.getElementById("search")?.value || "").toLowerCase().trim();
  filteredAlbums = q ? allAlbums.filter(a => ((a.album||"") + " " + (a.albumartist||a.artist||"")).toLowerCase().includes(q)) : allAlbums.slice();
  gridItemsToShow = PAGE_SIZE;
  renderAlbums();
  renderAlbumGrid();
}

// Debounced version for search input
let searchTimeout;
function debouncedFilterAlbums() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    filterAlbums();
  }, 300); // 300ms debounce
}

function renderLibraryStatistics(albums) {
  if (!albums || albums.length === 0) return;
  
  // Format Statistics
  const formats = {};
  albums.forEach(a => {
    (a.tracks || []).forEach(t => {
      const format = t.format || 'Unknown';
      formats[format] = (formats[format] || 0) + 1;
    });
  });
  renderStatCategory('format-stats', formats, 'tracks');
  
  // Genre Statistics (top 20)
  const genres = {};
  albums.forEach(a => {
    const genre = a.genre || a.genres || 'Unknown';
    const genreList = Array.isArray(genre) ? genre : [genre];
    genreList.forEach(g => {
      const cleaned = String(g).trim();
      if (cleaned) {
        genres[cleaned] = (genres[cleaned] || 0) + 1;
      }
    });
  });
  renderStatCategory('genre-stats', genres, 'albums', 20);
  
  // Year Statistics (original_year preferred, fallback to year)
  const years = {};
  albums.forEach(a => {
    const year = a.original_year || a.year || 'Unknown';
    years[year] = (years[year] || 0) + 1;
  });
  renderStatCategory('year-stats', years, 'albums', null, true);
  
  // Label Statistics (top 15)
  const labels = {};
  albums.forEach(a => {
    const label = a.label || 'Unknown';
    labels[label] = (labels[label] || 0) + 1;
  });
  renderStatCategory('label-stats', labels, 'albums', 15);
  
  // Missing Tracks (albums with disctotal > 1 but incomplete tracks)
  const missingAlbums = [];
  albums.forEach(a => {
    const disctotal = parseInt(a.disctotal) || 0;
    if (disctotal > 1) {
      const tracks = a.tracks || [];
      const discs = new Set(tracks.map(t => t.disc || 1));
      if (discs.size < disctotal) {
        missingAlbums.push({
          name: a.album || 'Unknown',
          artist: a.albumartist || a.artist || '',
          expected: disctotal,
          found: discs.size,
          album: a
        });
      }
    }
  });
  renderMissingTracks('missing-tracks-stats', missingAlbums);
}

function renderStatCategory(containerId, data, unit, limit = null, sortByKey = false) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  if (Object.keys(data).length === 0) {
    const empty = document.createElement('div');
    empty.className = 'stat-empty';
    empty.textContent = 'No data';
    container.appendChild(empty);
    return;
  }
  
  // Sort by count (descending) or by key (for years)
  let sorted = Object.entries(data);
  if (sortByKey) {
    sorted.sort((a, b) => String(b[0]).localeCompare(String(a[0])));
  } else {
    sorted.sort((a, b) => b[1] - a[1]);
  }
  
  // Limit results if specified
  if (limit) {
    sorted = sorted.slice(0, limit);
  }
  
  sorted.forEach(([name, count]) => {
    const item = document.createElement('div');
    item.className = 'stat-item';
    
    const nameEl = document.createElement('div');
    nameEl.className = 'stat-name';
    nameEl.textContent = name;
    nameEl.title = name; // Tooltip for long names
    
    const countEl = document.createElement('div');
    countEl.className = 'stat-count';
    countEl.textContent = count;
    
    item.appendChild(nameEl);
    item.appendChild(countEl);
    container.appendChild(item);
  });
}

function renderMissingTracks(containerId, albums) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  if (albums.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'stat-empty';
    empty.textContent = 'All complete!';
    container.appendChild(empty);
    return;
  }
  
  albums.forEach(missing => {
    const item = document.createElement('div');
    item.className = 'missing-album-item';
    item.onclick = () => {
      // Switch to Albums page and select this album
      const idx = allAlbums.indexOf(missing.album);
      if (idx >= 0) {
        document.querySelector('[data-page="albums"]').click();
        setTimeout(() => selectAlbum(idx), 100);
      }
    };
    
    const name = document.createElement('div');
    name.className = 'missing-album-name';
    name.textContent = missing.name;
    name.title = `${missing.name} - ${missing.artist}`;
    
    const info = document.createElement('div');
    info.className = 'missing-album-info';
    info.textContent = `${missing.found}/${missing.expected} discs`;
    
    item.appendChild(name);
    item.appendChild(info);
    container.appendChild(item);
  });
}

function renderRecentArtists(albums) {
  const recentArtists = []; const seen = new Set();
  for (const a of albums) {
    const name = a.albumartist || a.artist || "(Unknown artist)";
    if (!seen.has(name)) { seen.add(name); recentArtists.push(a); if (recentArtists.length >= 40) break; }
  }
  const container = document.getElementById("recent-artists");
  if (!container) return;
  container.innerHTML = "";
  recentArtists.forEach((a) => {
    const row = document.createElement("div"); row.className = "artist-row";
    const img = document.createElement("img"); img.src = coverUrlFor(a);
    img.onerror = () => { img.onerror = null; img.src = "/static/placeholder.jpg"; };
    const textWrap = document.createElement("div");
    const nameDiv = document.createElement("div"); nameDiv.className = "artist-name"; nameDiv.textContent = a.albumartist || a.artist || "";
    const metaDiv = document.createElement("div"); metaDiv.className = "artist-meta"; metaDiv.textContent = (a.year || "");
    textWrap.appendChild(nameDiv); textWrap.appendChild(metaDiv);
    row.appendChild(img); row.appendChild(textWrap); container.appendChild(row);
  });
}

// ==================== ALBUMS PAGE ====================

function renderAlbumsSidebar() {
  const container = document.getElementById("albums-sidebar-list");
  if (!container) return;
  container.innerHTML = "";
  filteredSidebarAlbums.forEach((a, idx) => {
    const item = document.createElement("div");
    item.className = "sidebar-album-item";
    item.dataset.idx = idx;
    item.dataset.originalIdx = allAlbums.indexOf(a);
    item.onclick = () => selectAlbum(allAlbums.indexOf(a));

    const thumb = document.createElement("div"); thumb.className = "sidebar-album-thumb";
    const img = document.createElement("img"); img.src = coverUrlFor(a);
    img.onerror = () => { img.onerror = null; img.src = "/static/placeholder.jpg"; };
    thumb.appendChild(img);

    const info = document.createElement("div"); info.className = "sidebar-album-info";
    const name = document.createElement("div"); name.className = "sidebar-album-name"; name.textContent = a.album || "(Unknown)";
    const artist = document.createElement("div"); artist.className = "sidebar-album-artist"; artist.textContent = a.albumartist || a.artist || "";
    info.appendChild(name); info.appendChild(artist);

    const year = document.createElement("div"); year.className = "sidebar-album-year"; year.textContent = a.year || "";

    item.appendChild(thumb); item.appendChild(info); item.appendChild(year);
    container.appendChild(item);
  });
}

function filterSidebarAlbums() {
  const q = (document.getElementById("albums-search")?.value || "").toLowerCase().trim();
  filteredSidebarAlbums = q 
    ? allAlbums.filter(a => ((a.album||"") + " " + (a.albumartist||a.artist||"")).toLowerCase().includes(q)) 
    : allAlbums.slice();
  renderAlbumsSidebar();
}

function selectAlbum(idx) {
  currentSelectedAlbum = idx;
  document.querySelectorAll(".sidebar-album-item").forEach(el => el.classList.remove("active"));
  const selected = document.querySelector(`.sidebar-album-item[data-original-idx="${idx}"]`);
  if (selected) selected.classList.add("active");
  renderAlbumDetail(allAlbums[idx]);
}

function renderAlbumDetail(album) {
  const panel = document.getElementById("albums-detail-panel");
  const infoSection = document.getElementById("albums-current-info");
  
  if (!album) {
    panel.innerHTML = "";
    const empty = document.createElement("div");
    empty.className = "albums-detail-empty";
    empty.innerHTML = '<div class="empty-icon">??</div><div>Select an album to view its tracks</div>';
    panel.appendChild(empty);
    
    // Clear top info
    if (infoSection) {
      infoSection.innerHTML = "";
      infoSection.className = "albums-current-album-info empty";
    }
    return;
  }

  debugLog(`Rendering album: ${album.album}`);
  debugLog(`Album path/folder: ${album.path || album.folder || album.directory || 'NONE'}`);
  debugLog(`Tracks count: ${album.tracks?.length || 0}`);

  const tracks = album.tracks || [];
  let totalSeconds = 0;
  tracks.forEach(t => { totalSeconds += (t.length || 0); });

  // Update top info section
  if (infoSection) {
    infoSection.innerHTML = "";
    infoSection.className = "albums-current-album-info";
    
    const coverDiv = document.createElement("div");
    coverDiv.className = "albums-current-album-cover";
    const coverImg = document.createElement("img");
    coverImg.src = coverUrlFor(album);
    coverImg.onerror = () => { coverImg.onerror = null; coverImg.src = "/static/placeholder.jpg"; };
    coverDiv.appendChild(coverImg);
    
    const textDiv = document.createElement("div");
    textDiv.className = "albums-current-album-text";
    
    const titleEl = document.createElement("div");
    titleEl.className = "albums-current-album-title";
    titleEl.textContent = album.album || "(Unknown album)";
    
    const artistEl = document.createElement("div");
    artistEl.className = "albums-current-album-artist";
    artistEl.textContent = album.albumartist || album.artist || "";
    
    const metaParts = [];
    if (album.year) metaParts.push(album.year);
    if (tracks.length) metaParts.push(tracks.length + " tracks");
    if (totalSeconds > 0) metaParts.push(formatCompactTime(totalSeconds + " seconds"));
    
    const metaEl = document.createElement("div");
    metaEl.className = "albums-current-album-meta";
    metaEl.textContent = metaParts.join("   ");
    
    textDiv.appendChild(titleEl);
    textDiv.appendChild(artistEl);
    textDiv.appendChild(metaEl);
    
    infoSection.appendChild(coverDiv);
    infoSection.appendChild(textDiv);
  }

  panel.innerHTML = "";

  const trackContainer = document.createElement("div"); trackContainer.className = "tracklist-container";

  if (tracks.length === 0) {
    const empty = document.createElement("div");
    empty.style.cssText = "padding: 32px 16px; color: #666; font-size: 13px; text-align: center;";
    empty.textContent = "No track data available for this album.";
    trackContainer.appendChild(empty);
  } else {
    const table = document.createElement("table"); table.className = "tracklist-table";
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    ["#", "Title", "Artist", "Quality", "Duration"].forEach(h => {
      const th = document.createElement("th"); th.textContent = h; headerRow.appendChild(th);
    });
    thead.appendChild(headerRow); table.appendChild(thead);

    const tbody = document.createElement("tbody");
    tracks.forEach((t, i) => {
      const tr = document.createElement("tr");
      tr.dataset.trackIndex = i;
      
      tr.onclick = () => playTrack(album, i);
      
      const numTd = document.createElement("td"); numTd.className = "track-num"; numTd.textContent = (t.track || (i+1));
      const titleTd = document.createElement("td"); titleTd.className = "track-title"; titleTd.textContent = t.title || "(Untitled)";
      const artistTd = document.createElement("td"); artistTd.textContent = t.artist || album.albumartist || album.artist || "";
      const durTd = document.createElement("td"); durTd.className = "track-duration"; durTd.textContent = formatTrackDuration(t.length);
      const qualityTd = document.createElement("td");
      qualityTd.style.fontSize = "11px";
      qualityTd.style.color = "#0ff";
      qualityTd.style.fontVariantNumeric = "tabular-nums";
      let qualityStr = t.format || "?";
      if (t.bitdepth || t.samplerate) {
        const bitdepth = t.bitdepth || "?";
        const samplerate = t.samplerate ? (t.samplerate / 1000).toFixed(1) : "?";
        qualityStr += " • " + bitdepth + "/" + samplerate;
      } else if (t.bitrate) {
        const kbps = Math.round(t.bitrate / 1000);
        qualityStr += " • " + kbps + "kbps";
      }
      qualityTd.textContent = qualityStr;
      tr.appendChild(numTd); tr.appendChild(titleTd); tr.appendChild(artistTd); tr.appendChild(qualityTd); tr.appendChild(durTd);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    trackContainer.appendChild(table);
  }
  panel.appendChild(trackContainer);

  // Initialize player if not already done
  if (!player) {
    initializePlayer();
  }
  
  currentAlbumData = album;
  currentPlaylist = tracks;
}

// ==================== AUDIO PLAYER ====================

function initializePlayer() {
  const audioEl = document.getElementById("audio-player");
  if (!audioEl) return;

  if (player) {
    player.destroy();
  }

  player = new Plyr(audioEl, {
    controls: [
      'play-large',
      'play',
      'progress',
      'current-time',
      'duration',
      'mute',
      'volume',
      'settings',
      'download'
    ],
    settings: ['speed', 'loop'],
    speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
    keyboard: { focused: true, global: true }
  });

  player.on('ended', () => {
    playNextTrack();
  });

  player.on('error', (event) => {
    debugLog(`Player error: ${JSON.stringify(event)}`, 'error');
  });
}

function getTrackPath(album, track) {
  debugLog(`Getting track path for: ${track.title}`);
  debugLog(`Track object: ${JSON.stringify(track, null, 2)}`);
  debugLog(`Album object keys: ${Object.keys(album).join(', ')}`);
  
  let trackPath = track.path || track.file || track.filename || track._path;
  
  debugLog(`Track path field: ${trackPath || 'NONE'}`);
  
  if (trackPath && trackPath.startsWith('/')) {
    if (trackPath.startsWith('/music/library')) {
      debugLog(`Using full track path (already prefixed): ${trackPath}`);
      return trackPath;
    } else {
      const fullPath = `/music/library${trackPath}`;
      debugLog(`Using full track path: ${fullPath}`);
      return fullPath;
    }
  }
  
  const albumFolder = album.path || album.folder || album.directory || album.example_path || album._path;
  debugLog(`Album folder: ${albumFolder || 'NONE'}`);
  
  if (albumFolder && trackPath) {
    const cleanFolder = albumFolder.replace(/\/$/, '');
    const cleanTrack = trackPath.replace(/^\//, '');
    const fullPath = `/music/library${cleanFolder}/${cleanTrack}`;
    debugLog(`Built path: ${fullPath}`);
    return fullPath;
  }
  
  if (albumFolder && track.title) {
    const extensions = ['.flac', '.mp3', '.m4a', '.ogg', '.wav', '.opus'];
    for (const ext of extensions) {
      const possiblePath = `/music/library${albumFolder}/${track.title}${ext}`;
      debugLog(`Trying extension guess: ${possiblePath}`, 'warning');
      return possiblePath;
    }
  }
  
  debugLog('Could not determine track path!', 'error');
  return null;
}

function playTrack(album, trackIndex) {
  const track = album.tracks[trackIndex];
  if (!track) {
    debugLog('Track not found at index ' + trackIndex, 'error');
    return;
  }

  debugLog(`=== PLAYING TRACK ${trackIndex} ===`);
  const trackPath = getTrackPath(album, track);
  
  if (!trackPath) {
    debugLog("Could not determine track path", 'error');
    alert('Cannot play this track - path could not be determined. Check debug console for details.');
    return;
  }

  debugLog(`Final track path: ${trackPath}`);
  
  currentTrackIndex = trackIndex;
  currentAlbumData = album;
  currentPlaylist = album.tracks;

  if (player) {
    const mimeType = getAudioMimeType(trackPath);
    debugLog(`MIME type: ${mimeType}`);
    
    player.source = {
      type: 'audio',
      sources: [
        {
          src: trackPath,
          type: mimeType
        }
      ]
    };
    
    player.play().then(() => {
      debugLog('Playback started successfully');
    }).catch((error) => {
      debugLog(`Playback failed: ${error.message}`, 'error');
      alert(`Failed to play track. Check debug console.\nPath: ${trackPath}\nError: ${error.message}`);
    });
  } else {
    debugLog('Player not initialized', 'error');
    debugLog('Attempting to reinitialize player...', 'warning');
    initializePlayer();
    setTimeout(() => playTrack(album, trackIndex), 100);
  }

  updateNowPlayingInfo(album, track);
  
  updateTrackHighlight(trackIndex);
}

function getAudioMimeType(path) {
  const ext = path.split('.').pop().toLowerCase();
  const mimeTypes = {
    'flac': 'audio/flac',
    'mp3': 'audio/mpeg',
    'wav': 'audio/wav',
    'ogg': 'audio/ogg',
    'opus': 'audio/opus',
    'm4a': 'audio/mp4',
    'aac': 'audio/aac',
    'weba': 'audio/webm'
  };
  return mimeTypes[ext] || 'audio/mpeg';
}

function updateNowPlayingInfo(album, track) {
  const infoDiv = document.getElementById("now-playing-info");
  if (!infoDiv) return;

  infoDiv.innerHTML = "";

  const coverDiv = document.createElement("div");
  coverDiv.className = "now-playing-cover";
  const coverImg = document.createElement("img");
  coverImg.src = coverUrlFor(album);
  coverImg.onerror = () => { coverImg.onerror = null; coverImg.src = "/static/placeholder.jpg"; };
  coverDiv.appendChild(coverImg);

  const textDiv = document.createElement("div");
  textDiv.className = "now-playing-text";

  const trackTitle = document.createElement("div");
  trackTitle.className = "now-playing-track";
  trackTitle.textContent = track.title || "(Untitled)";

  const artistName = document.createElement("div");
  artistName.className = "now-playing-artist";
  artistName.textContent = track.artist || album.albumartist || album.artist || "";

  const albumName = document.createElement("div");
  albumName.className = "now-playing-album";
  albumName.textContent = album.album || "";

  textDiv.appendChild(trackTitle);
  textDiv.appendChild(artistName);
  textDiv.appendChild(albumName);

  infoDiv.appendChild(coverDiv);
  infoDiv.appendChild(textDiv);
}

function updateTrackHighlight(trackIndex) {
  document.querySelectorAll(".tracklist-table tbody tr").forEach(tr => {
    tr.classList.remove("playing");
  });

  const currentRow = document.querySelector(`.tracklist-table tbody tr[data-track-index="${trackIndex}"]`);
  if (currentRow) {
    currentRow.classList.add("playing");
  }
}

function playNextTrack() {
  if (!currentPlaylist || currentPlaylist.length === 0) return;
  
  const nextIndex = currentTrackIndex + 1;
  if (nextIndex < currentPlaylist.length) {
    playTrack(currentAlbumData, nextIndex);
  }
}

function playPreviousTrack() {
  if (!currentPlaylist || currentPlaylist.length === 0) return;
  
  const prevIndex = currentTrackIndex - 1;
  if (prevIndex >= 0) {
    playTrack(currentAlbumData, prevIndex);
  }
}

// ==================== PLAYLIST BUILDER ====================

let currentPlaylistData = null;

function initPlaylistBuilder() {
  const uploadZone = document.getElementById('upload-zone');
  const fileInput = document.getElementById('csv-file-input');
  
  // Click to upload
  uploadZone.addEventListener('click', () => {
    fileInput.click();
  });
  
  // File selection
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      handleCSVFile(file);
    }
  });
  
  // Drag and drop
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
  });
  
  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
  });
  
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      handleCSVFile(file);
    } else {
      alert('Please upload a CSV file');
    }
  });
  
  // Save playlist button
  document.getElementById('save-playlist-btn').addEventListener('click', savePlaylistToVolumio);
  
  // Clear playlist button
  document.getElementById('clear-playlist-btn').addEventListener('click', clearPlaylist);
}

async function handleCSVFile(file) {
  showLoading();
  
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/playlist/build', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Failed to build playlist');
    }
    
    const data = await response.json();
    currentPlaylistData = data.playlist;
    
    displayPlaylistResults(data);
    
  } catch (error) {
    console.error('Playlist build error:', error);
    alert(`Error building playlist: ${error.message}`);
  } finally {
    hideLoading();
  }
}

function displayPlaylistResults(data) {
  const resultsSection = document.getElementById('playlist-results');
  const tracksContainer = document.getElementById('playlist-tracks');
  
  // Update stats
  document.getElementById('playlist-total').textContent = data.tracks;
  document.getElementById('playlist-matched').textContent = data.playlist.length;
  document.getElementById('playlist-unmatched').textContent = data.tracks - data.playlist.length;
  
  // Show results section
  resultsSection.style.display = 'flex';
  
  // Render tracks
  tracksContainer.innerHTML = '';
  
  if (data.playlist.length === 0) {
    tracksContainer.innerHTML = '<div class="playlist-empty">No tracks matched in your library</div>';
    return;
  }
  
  data.playlist.forEach((track, index) => {
    const item = document.createElement('div');
    item.className = 'playlist-track-item';
    
    const number = document.createElement('div');
    number.className = 'playlist-track-number';
    number.textContent = index + 1;
    
    const info = document.createElement('div');
    info.className = 'playlist-track-info';
    
    const title = document.createElement('div');
    title.className = 'playlist-track-title';
    title.textContent = track.title;
    
    const meta = document.createElement('div');
    meta.className = 'playlist-track-meta';
    meta.textContent = `${track.artist}   ${track.album}`;
    
    info.appendChild(title);
    info.appendChild(meta);
    
    const status = document.createElement('div');
    status.className = 'playlist-track-status';
    status.textContent = 'Matched';
    
    item.appendChild(number);
    item.appendChild(info);
    item.appendChild(status);
    
    tracksContainer.appendChild(item);
  });
  
  // Set default playlist name
  const now = new Date();
  const defaultName = `Playlist_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  document.getElementById('playlist-name-input').value = defaultName;
}

async function savePlaylistToVolumio() {
  const playlistName = document.getElementById('playlist-name-input').value.trim();
  
  if (!playlistName) {
    alert('Please enter a playlist name');
    return;
  }
  
  if (!currentPlaylistData || currentPlaylistData.length === 0) {
    alert('No playlist data to save');
    return;
  }
  
  showLoading();
  
  try {
    const formData = new FormData();
    formData.append('playlist_name', playlistName);
    formData.append('playlist_data', JSON.stringify(currentPlaylistData));
    
    const response = await fetch('/api/playlist/save', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Failed to save playlist');
    }
    
    const data = await response.json();
    
    let message = `? Playlist saved!\n\n${playlistName}\n${data.tracks} tracks\n\n`;
    
    if (data.volumio_pushed) {
      message += `?? Successfully pushed to Volumio!\n${data.volumio_message}\n\nThe playlist should appear in Volumio immediately.`;
    } else {
      message += `?? Saved locally but could not push to Volumio:\n${data.volumio_message}\n\nYou may need to manually copy the playlist to Volumio.`;
    }
    
    alert(message);
    
  } catch (error) {
    console.error('Save playlist error:', error);
    alert(`Error saving playlist: ${error.message}`);
  } finally {
    hideLoading();
  }
}

function clearPlaylist() {
  currentPlaylistData = null;
  document.getElementById('playlist-results').style.display = 'none';
  document.getElementById('csv-file-input').value = '';
}

/* =============================================================================
   SLSKD SEARCH JAVASCRIPT - Add to index.html <script> section
   ============================================================================= */

// Global state for slskd
let currentSearchData = null;

function openSlskdSearch(albumData, missingInfo) {
  console.log('Opening slskd search for:', albumData.album);
  
  // Show modal
  const modal = document.getElementById('slskd-search-modal');
  if (!modal) {
    console.error('slskd modal not found!');
    return;
  }
  
  modal.classList.add('active');
  
  // Update modal content
  document.getElementById('slskd-album-name').textContent = 
    `${albumData.albumartist} - ${albumData.album}`;
  
  document.getElementById('slskd-missing-info').textContent = 
    `Missing ${missingInfo.expected - missingInfo.found} disc(s)`;
  
  // Show loading
  const resultsContainer = document.getElementById('slskd-results-list');
  resultsContainer.innerHTML = '<div class="slskd-loading">Searching slskd</div>';
  
  // Perform search
  performSlskdSearch(albumData, missingInfo);
}

function closeSlskdSearch() {
  const modal = document.getElementById('slskd-search-modal');
  if (modal) {
    modal.classList.remove('active');
  }
  currentSearchData = null;
}

async function performSlskdSearch(albumData, missingInfo) {
  try {
    const artist = albumData.albumartist || albumData.artist;
    const album = albumData.album;
    
    // Build search URL
    const params = new URLSearchParams({
      artist: artist,
      album: album,
      file_type: 'flac'
    });
    
    const response = await fetch(`/api/slskd/search?${params}`);
    
    if (!response.ok) {
      throw new Error(`Search failed: ${response.status}`);
    }
    
    const data = await response.json();
    currentSearchData = data;
    
    displaySlskdResults(data, albumData);
    
  } catch (error) {
    console.error('slskd search error:', error);
    
    const resultsContainer = document.getElementById('slskd-results-list');
    resultsContainer.innerHTML = `
      <div class="slskd-no-results">
        Search failed: ${error.message}
      </div>
    `;
  }
}

function displaySlskdResults(data, albumData) {
  const resultsContainer = document.getElementById('slskd-results-list');
  
  if (data.error) {
    resultsContainer.innerHTML = `
      <div class="slskd-no-results">
        Error: ${data.error}
      </div>
    `;
    return;
  }
  
  if (!data.results || data.results.length === 0) {
    resultsContainer.innerHTML = `
      <div class="slskd-no-results">
        No results found for "${data.query}"
      </div>
    `;
    return;
  }
  
  resultsContainer.innerHTML = '';
  
  data.results.forEach((result, index) => {
    const item = document.createElement('div');
    item.className = 'slskd-result-item';
    
    const info = document.createElement('div');
    info.className = 'slskd-result-info';
    
    const filename = document.createElement('div');
    filename.className = 'slskd-result-filename';
    filename.textContent = result.filename;
    filename.title = result.filename;
    
    const meta = document.createElement('div');
    meta.className = 'slskd-result-meta';
    
    meta.innerHTML = `
      <span>?? ${result.username}</span>
      <span>?? ${formatFileSize(result.size)}</span>
      ${result.bitrate ? `<span class="slskd-result-quality">?? ${result.bitrate} kbps</span>` : ''}
      ${result.length ? `<span>?? ${formatDuration(result.length)}</span>` : ''}
    `;
    
    info.appendChild(filename);
    info.appendChild(meta);
    
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'slskd-download-btn';
    downloadBtn.textContent = 'Download';
    downloadBtn.onclick = () => downloadFromSlskd(result, downloadBtn);
    
    item.appendChild(info);
    item.appendChild(downloadBtn);
    
    resultsContainer.appendChild(item);
  });
}

async function downloadFromSlskd(result, button) {
  button.disabled = true;
  button.textContent = 'Queueing...';
  
  try {
    const formData = new FormData();
    formData.append('username', result.username);
    formData.append('filename', result.filename);
    formData.append('search_id', result.search_id);
    
    const response = await fetch('/api/slskd/download', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      button.textContent = '? Queued';
      button.style.background = '#0f0';
      
      setTimeout(() => {
        button.textContent = 'Download';
        button.style.background = '';
        button.disabled = false;
      }, 3000);
      
      console.log('Download queued:', data);
    } else {
      throw new Error(data.error || 'Download failed');
    }
    
  } catch (error) {
    console.error('Download error:', error);
    button.textContent = '? Failed';
    button.style.background = '#f00';
    
    setTimeout(() => {
      button.textContent = 'Download';
      button.style.background = '';
      button.disabled = false;
    }, 3000);
  }
}

function formatFileSize(bytes) {
  if (!bytes) return '-';
  const mb = bytes / 1024 / 1024;
  if (mb < 1024) return mb.toFixed(1) + ' MB';
  return (mb / 1024).toFixed(2) + ' GB';
}

function formatDuration(seconds) {
  if (!seconds) return '-';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${String(secs).padStart(2, '0')}`;
}

// Update the renderMissingTracks function to include search button
function renderMissingTracks(containerId, albums) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  if (albums.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'stat-empty';
    empty.textContent = 'All complete!';
    container.appendChild(empty);
    return;
  }
  
  albums.forEach(missing => {
    const item = document.createElement('div');
    item.className = 'missing-album-item';
    
    const name = document.createElement('div');
    name.className = 'missing-album-name';
    name.textContent = missing.name;
    name.title = `${missing.name} - ${missing.artist}`;
    
    const info = document.createElement('div');
    info.className = 'missing-album-info';
    info.innerHTML = `${missing.found}/${missing.expected} discs`;
    
    // Add search button
    const searchBtn = document.createElement('button');
    searchBtn.className = 'search-missing-btn';
    searchBtn.textContent = '?? Search';
    searchBtn.onclick = (e) => {
      e.stopPropagation();
      openSlskdSearch(missing.album, missing);
    };
    
    info.appendChild(searchBtn);
    
    // Keep the click to navigate functionality
    item.onclick = () => {
      const idx = allAlbums.indexOf(missing.album);
      if (idx >= 0) {
        document.querySelector('[data-page="albums"]').click();
        setTimeout(() => selectAlbum(idx), 100);
      }
    };
    
    item.appendChild(name);
    item.appendChild(info);
    container.appendChild(item);
  });
}




// ==================== INIT ====================

document.addEventListener("DOMContentLoaded", () => {
  loadStats();
  loadInboxStats();
  loadInboxTree();
  loadAlbums();
  loadAndRenderLibraryStats(); // Load detailed stats from API
  initPlaylistBuilder();

  document.getElementById("grid-load-more").onclick = () => { gridItemsToShow += PAGE_SIZE; renderAlbumGrid(); };
  
  // Use debounced search for better performance
  document.getElementById("search").addEventListener("input", debouncedFilterAlbums);
  document.getElementById("albums-search").addEventListener("input", filterSidebarAlbums);
  
  document.getElementById("clear-logs-btn").onclick = clearWatcherLogs;
  document.getElementById("pause-logs-btn").onclick = toggleLogsPause;

  // Poll watcher status every 5 seconds (reduced from 2 seconds for better performance)
  let pollingInterval = setInterval(updateWatcherStatus, 5000);
  
  // Pause polling when tab is hidden to save resources
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    } else {
      if (!pollingInterval) {
        updateWatcherStatus(); // Immediate update when returning
        pollingInterval = setInterval(updateWatcherStatus, 5000);
      }
    }
  });

  // Refresh stats and inbox periodically (every 30 seconds)
  setInterval(() => { 
    loadStats(); 
    loadInboxStats(); 
    loadInboxTree();
    loadAndRenderLibraryStats(); // Refresh detailed stats
  }, 30000);
});
</script>
</body>
</html>