<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Beets Album Status</title>

<!-- Plyr.js Audio Player -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<style>
/* ==================== Neon Dark Theme ==================== */

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  margin: 0;
  padding: 0;
  background-color: #121212;
  color: #eee;
  overflow-x: hidden; /* prevents horizontal scroll blowout */
}

/* ==================== NAV TABS ==================== */

.nav-tabs {
  display: flex;
  background: #1a1a1a;
  border-bottom: 1px solid #333;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.nav-tab {
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 600;
  color: #888;
  cursor: pointer;
  border: none;
  background: none;
  border-bottom: 3px solid transparent;
  transition: color 0.2s, border-color 0.2s;
  margin: 0;
  border-radius: 0;
  transform: none;
}
.nav-tab:hover {
  color: #ccc;
  transform: none;
  background: none;
}
.nav-tab.active {
  color: #0ff;
  border-bottom-color: #0ff;
}

/* ==================== PAGE CONTENT ==================== */

.page {
  display: none;
  padding: 12px 16px;
}
.page.active {
  display: block;
}

/* Headings */
h1 {
  margin-top: 0;
  margin-bottom: 12px;
  color: #f0f;
}
h2 {
  margin: 0 0 8px 0;
  font-size: 16px;
  color: #0ff;
}
h3 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #0cc;
}

/* Buttons */
button {
  margin: 2px 4px 2px 0;
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
  background: #f0f;
  border: 1px solid #f0f;
  border-radius: 4px;
  color: #fff;
  transition: background 0.2s, transform 0.1s;
}
button:hover {
  background: #f0a;
  transform: scale(1.02);
}
button:disabled {
  background: #555;
  border-color: #555;
  cursor: not-allowed;
  opacity: 0.5;
}

/* Layout containers */
.top-container {
  display: grid;
  grid-template-columns: 280px;
  gap: 16px;
  margin-bottom: 12px;
}
.bottom-container {
  display: grid;
  grid-template-columns: 280px 1fr 280px 320px;
  gap: 16px;
  /* grid-template-rows locked by JS after grid renders */
}

/* Boxes */
.box {
  background: #222;
  border-radius: 8px;
  padding: 12px 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  border: 1px solid #333;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}
/* Grid box: sizes ONLY to its own content. Must not stretch or clip. */
.album-grid-box {
  align-self: start;
  overflow: visible;
}

/* Stats */
.stats-box div {
  margin-bottom: 4px;
  font-size: 13px;
  color: #eee;
}

/* Album list */
.albums-box h2 { flex-shrink: 0; }
#search { 
  flex-shrink: 0;
  width: 100%;
  padding: 6px 8px;
  margin-bottom: 8px;
  border-radius: 4px;
  border: 1px solid #444;
  background: #111;
  color: #eee;
  font-size: 13px;
  box-sizing: border-box;
}
#album-list {
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}
.album-row {
  padding: 4px 0;
  border-bottom: 1px solid #444;
}
.album-title {
  font-weight: 500;
  color: #fff;
  font-size: 12px;
}
.album-meta {
  font-size: 11px;
  color: #bbb;
}

/* Album grid */
.album-grid-container {
  /* no scroll — grid renders all visible items flat */
}
.album-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}
.album-grid-item {
  background: #181818;
  border-radius: 2px;
  padding: 2px;
  border: 1px solid #333;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 11px;
}
.album-grid-cover {
  width: 90px;
  height: 90px;
  background: #111;
  border-radius: 2px;
  overflow: hidden;
  border: 1px solid #444;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.album-grid-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.album-grid-title {
  font-weight: 500;
  color: #fff;
  text-align: center;
  font-size: 11px;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.album-grid-meta {
  font-size: 10px;
  color: #bbb;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

/* Pagination controls */
.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #333;
  flex-shrink: 0;
}
.pagination-info { font-size: 12px; color: #999; }
.pagination-buttons { display: flex; gap: 4px; }
.pagination-buttons button { padding: 4px 8px; font-size: 12px; }

/* Recent Artists */
.artists-box h2 { flex-shrink: 0; }
#recent-artists {
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}
.artist-row {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}
.artist-row img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin-right: 8px;
  object-fit: cover;
  border: 1px solid #555;
  background: #222;
  flex-shrink: 0;
}
.artist-name { font-weight: 500; color: #eee; font-size: 12px; }
.artist-meta { font-size: 11px; color: #999; }

/* Inbox */
.inbox-box h2 { flex-shrink: 0; }
#inbox-summary {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px 12px;
  margin-bottom: 8px;
  flex-shrink: 0;
}
#inbox-summary div { font-size: 13px; color: #eee; }
#inbox-summary .full-width { grid-column: 1 / -1; }
.inbox-note {
  font-size: 12px;
  color: #999;
  margin-top: 8px;
  line-height: 1.4;
  flex-shrink: 0;
}
.inbox-scrollable {
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}
#inbox-tree {
  margin-top: 10px;
  font-size: 13px;
  color: #ccc;
}
#inbox-files {
  margin-top: 12px;
  font-size: 13px;
  color: #eee;
}
#inbox-files ul { padding-left: 16px; margin: 8px 0; }
#inbox-files li { margin-bottom: 2px; }
.inbox-artist { font-weight: 500; margin-top: 4px; color: #0ff; }
.inbox-albums { margin-left: 8px; }
.inbox-album { cursor: pointer; color: #ccc; margin: 2px 0; }
.inbox-album:hover { color: #fff; }

/* Loading indicator */
#loading {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #222;
  padding: 8px 10px;
  border: 1px solid #555;
  border-radius: 4px;
  z-index: 999;
  font-size: 12px;
  color: #0ff;
}

/* Debug console */
.debug-console {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #1a1a1a;
  border: 1px solid #f00;
  border-radius: 4px;
  padding: 8px;
  max-width: 400px;
  max-height: 200px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 11px;
  color: #0f0;
  z-index: 1000;
  display: none;
}
.debug-console.active {
  display: block;
}
.debug-line {
  margin: 2px 0;
  white-space: pre-wrap;
  word-break: break-all;
}
.debug-error {
  color: #f00;
}
.debug-warning {
  color: #ff0;
}

/* ==================== ALBUMS PAGE ==================== */

.albums-page-header {
  background: #222;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

#albums-search {
  width: 100%;
  padding: 12px 16px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #1a1a1a;
  color: #eee;
  font-size: 15px;
  box-sizing: border-box;
  transition: border-color 0.2s, background 0.2s;
}

#albums-search:focus {
  outline: none;
  border-color: #0ff;
  background: #222;
}

#albums-search::placeholder {
  color: #888;
}

.albums-page-layout {
  display: grid;
  grid-template-columns: 240px 1fr;
  gap: 16px;
  height: calc(100vh - 140px);
}

/* Left sidebar: recent album list */
.albums-sidebar {
  background: #222;
  border-radius: 8px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.albums-sidebar h2 {
  padding: 12px 14px 0 14px;
  flex-shrink: 0;
}
.albums-sidebar-list {
  overflow-y: auto;
  flex: 1;
  padding: 8px 10px;
}
.sidebar-album-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
  border: 1px solid transparent;
}
.sidebar-album-item:hover {
  background: #2a2a2a;
}
.sidebar-album-item.active {
  background: #1e3a3a;
  border-color: #0ff3;
}
.sidebar-album-thumb {
  width: 48px;
  height: 48px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #444;
  flex-shrink: 0;
  background: #111;
}
.sidebar-album-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.sidebar-album-info {
  min-width: 0;
  flex: 1;
}
.sidebar-album-name {
  font-size: 12px;
  font-weight: 500;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sidebar-album-artist {
  font-size: 11px;
  color: #999;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sidebar-album-year {
  font-size: 10px;
  color: #666;
  flex-shrink: 0;
}

/* Right panel: tracklist */
.albums-detail-panel {
  background: #222;
  border-radius: 8px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.albums-detail-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  border-bottom: 1px solid #333;
  flex-shrink: 0;
}
.albums-detail-cover {
  width: 100px;
  height: 100px;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #444;
  flex-shrink: 0;
  background: #111;
}
.albums-detail-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.albums-detail-info {
  flex: 1;
  min-width: 0;
}
.albums-detail-title {
  font-size: 20px;
  font-weight: 600;
  color: #fff;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.albums-detail-artist {
  font-size: 14px;
  color: #0ff;
  margin-bottom: 4px;
}
.albums-detail-meta {
  font-size: 12px;
  color: #888;
}

/* Tracklist table */
.tracklist-container {
  overflow-y: auto;
  flex: 1;
  padding: 8px 0;
}
.tracklist-table {
  width: 100%;
  border-collapse: collapse;
}
.tracklist-table th {
  text-align: left;
  font-size: 11px;
  color: #666;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 6px 16px;
  border-bottom: 1px solid #333;
  position: sticky;
  top: 0;
  background: #222;
}
.tracklist-table td {
  padding: 8px 16px;
  font-size: 13px;
  color: #ccc;
  border-bottom: 1px solid #2a2a2a;
}
.tracklist-table tr:last-child td {
  border-bottom: none;
}
.tracklist-table tr:hover td {
  background: #2a2a2a;
  color: #fff;
}
.track-num {
  color: #666;
  font-size: 12px;
  width: 32px;
}
.track-title {
  font-weight: 500;
  color: #eee;
}
.track-duration {
  color: #777;
  text-align: right;
  font-size: 12px;
  font-variant-numeric: tabular-nums;
}
.tracklist-table tbody tr {
  cursor: pointer;
  transition: background 0.15s;
}
.tracklist-table tbody tr:hover {
  background: #2a2a2a !important;
}
.tracklist-table tbody tr.playing {
  background: #1a3a3a !important;
}
.tracklist-table tbody tr.playing .track-title {
  color: #0ff;
}

/* Audio Player Box */
.audio-player-box {
  background: #1a1a1a;
  border-radius: 8px;
  padding: 16px;
  margin: 16px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  flex-shrink: 0;
}
.audio-player-box h3 {
  margin: 0 0 12px 0;
  font-size: 14px;
  color: #0ff;
  font-weight: 600;
}
.now-playing-info {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}
.now-playing-cover {
  width: 60px;
  height: 60px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #444;
  background: #111;
  flex-shrink: 0;
}
.now-playing-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.now-playing-text {
  flex: 1;
  min-width: 0;
}
.now-playing-track {
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}
.now-playing-artist {
  font-size: 12px;
  color: #0ff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.now-playing-album {
  font-size: 11px;
  color: #888;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Plyr.js Custom Styling */
.plyr--audio .plyr__controls {
  background: #222;
  border-radius: 6px;
  padding: 12px;
  border: 1px solid #333;
}
.plyr__control--overlaid {
  background: #f0f;
}
.plyr__control--overlaid:hover {
  background: #f0a;
}
.plyr__control:hover {
  background: #f0f;
}
.plyr--audio .plyr__control.plyr__tab-focus,
.plyr--audio .plyr__control:hover,
.plyr--audio .plyr__control[aria-expanded=true] {
  background: #f0f;
  color: #fff;
}
.plyr--full-ui input[type=range] {
  color: #f0f;
}
.plyr__menu__container .plyr__control[role=menuitemradio][aria-checked=true]::before {
  background: #f0f;
}
.plyr--audio .plyr__progress__buffer {
  color: rgba(240, 0, 240, 0.25);
}

/* Empty state for audio player */
.audio-player-empty {
  padding: 24px;
  text-align: center;
  color: #666;
  font-size: 13px;
}

/* Empty state */
.albums-detail-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #555;
  font-size: 14px;
  gap: 8px;
}
.albums-detail-empty .empty-icon {
  font-size: 36px;
  opacity: 0.4;
}

/* ==================== WATCHER PAGE ==================== */

.watcher-page-layout {
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: calc(100vh - 60px);
  padding: 0;
}

.watcher-stats-section {
  background: #222;
  border-radius: 8px;
  padding: 16px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  flex-shrink: 0;
}

.watcher-stats-section h2 {
  margin: 0 0 16px 0;
  color: #0ff;
  font-size: 18px;
}

.watcher-stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}

.watcher-stat-card {
  background: #1a1a1a;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #333;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.watcher-stat-card .watcher-stat-value {
  font-size: 42px;
  font-weight: 700;
  color: #0ff;
  display: block;
  line-height: 1;
}

.watcher-stat-card .watcher-stat-label {
  font-size: 14px;
  color: #fff;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.watcher-stat-card .watcher-stat-description {
  font-size: 12px;
  color: #888;
}

.watcher-logs-section {
  background: #222;
  border-radius: 8px;
  padding: 16px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.watcher-logs-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-shrink: 0;
}

.watcher-logs-header h2 {
  margin: 0;
  color: #0ff;
  font-size: 18px;
}

.watcher-logs-section .log-controls {
  display: flex;
  gap: 8px;
}

.watcher-logs-section .log-controls button {
  font-size: 12px;
  padding: 6px 12px;
}

.watcher-logs-section .watcher-logs-container {
  flex: 1;
  overflow-y: auto;
  background: #111;
  border-radius: 6px;
  padding: 12px;
  border: 1px solid #333;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.6;
  min-height: 0;
}

/* Shared log entry styles (for watcher logs and debug console) */
.log-entry {
  padding: 2px 0;
  border-bottom: 1px solid #222;
}
.log-entry:last-child {
  border-bottom: none;
}
.log-timestamp {
  color: #666;
  margin-right: 8px;
}
.log-level {
  font-weight: 600;
  margin-right: 8px;
  text-transform: uppercase;
}
.log-level.info {
  color: #0ff;
}
.log-level.warning {
  color: #ff0;
}
.log-level.error {
  color: #f00;
}
.log-level.success {
  color: #0f0;
}
.log-message {
  color: #ccc;
}
.log-empty {
  color: #555;
  text-align: center;
  padding: 20px;
  font-style: italic;
}
</style>
</head>
<body>

<!-- NAV TABS -->
<div class="nav-tabs">
  <button class="nav-tab active" data-page="main">Main</button>
  <button class="nav-tab" data-page="albums">Albums</button>
  <button class="nav-tab" data-page="watcher">Watcher</button>
  <button class="nav-tab" id="debug-toggle" style="margin-left: auto;">Debug</button>
</div>

<!-- Loading indicator -->
<div id="loading" style="display:none;">Loading...</div>

<!-- Debug console -->
<div id="debug-console" class="debug-console"></div>

<!-- ==================== MAIN PAGE ==================== -->
<div class="page active" id="page-main">

  <!-- TOP: Stats -->
  <div class="top-container">
    <div class="box stats-box">
      <h2>Library Stats</h2>
      <div id="stats">
        <div>Tracks: …</div>
        <div>Albums: …</div>
        <div>Artists: …</div>
        <div>Total time: …</div>
        <div>Total size: …</div>
      </div>
    </div>
  </div>

  <!-- BOTTOM: list, grid, artists, inbox -->
  <div class="bottom-container">
    <div class="box albums-box">
      <h2>All Albums</h2>
      <input id="search" type="text" placeholder="Search albums or artists…" />
      <div id="album-list"></div>
    </div>

    <div class="box album-grid-box">
      <h2>Album Grid</h2>
      <div class="album-grid-container">
        <div id="album-grid" class="album-grid"></div>
      </div>
      <div class="pagination" id="grid-pagination">
        <div class="pagination-info" id="grid-page-info"></div>
        <div class="pagination-buttons">
          <button id="grid-load-more">Load More</button>
        </div>
      </div>
    </div>

    <div class="box artists-box">
      <h2>Recent Artists</h2>
      <div id="recent-artists"></div>
    </div>

    <div class="box inbox-box">
      <h2>Inbox</h2>
      <div id="inbox-summary">
        <div>Tracks: <span id="inbox-tracks">Loading…</span></div>
        <div>Artists: <span id="inbox-artists">Loading…</span></div>
        <div>Albums: <span id="inbox-albums">Loading…</span></div>
        <div class="full-width">Total time: <span id="inbox-time">Loading…</span></div>
        <div class="full-width">Total size: <span id="inbox-size">Loading…</span></div>
      </div>
      <div class="inbox-note">Expandable folders<br />Artist › Albums › Files</div>
      <div class="inbox-scrollable">
        <div id="inbox-tree"></div>
        <div id="inbox-files"></div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== ALBUMS PAGE ==================== -->
<div class="page" id="page-albums">
  <div class="albums-page-header">
    <input id="albums-search" type="text" placeholder="Search albums or artists…" />
  </div>
  <div class="albums-page-layout">
    <!-- Left sidebar -->
    <div class="albums-sidebar">
      <h2>Recent Albums</h2>
      <div class="albums-sidebar-list" id="albums-sidebar-list"></div>
    </div>
    <!-- Right detail panel -->
    <div class="albums-detail-panel" id="albums-detail-panel">
      <div class="albums-detail-empty">
        <div class="empty-icon">??</div>
        <div>Select an album to view its tracks</div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== WATCHER PAGE ==================== -->
<div class="page" id="page-watcher">
  <div class="watcher-page-layout">
    <div class="watcher-stats-section">
      <h2>Queue Status</h2>
      <div class="watcher-stats-grid">
        <div class="watcher-stat-card">
          <span class="watcher-stat-value" id="inbox-queue-count">0</span>
          <span class="watcher-stat-label">Inbox Queue</span>
          <span class="watcher-stat-description">Pending imports from inbox</span>
        </div>
        <div class="watcher-stat-card">
          <span class="watcher-stat-value" id="library-queue-count">0</span>
          <span class="watcher-stat-label">Library Queue</span>
          <span class="watcher-stat-description">Albums being processed</span>
        </div>
        <div class="watcher-stat-card">
          <span class="watcher-stat-value" id="cover-queue-count">0</span>
          <span class="watcher-stat-label">Cover Queue</span>
          <span class="watcher-stat-description">Cover art downloads</span>
        </div>
      </div>
    </div>
    
    <div class="watcher-logs-section">
      <div class="watcher-logs-header">
        <h2>Activity Log</h2>
        <div class="log-controls">
          <button id="clear-logs-btn">Clear Logs</button>
          <button id="pause-logs-btn">Pause</button>
        </div>
      </div>
      <div class="watcher-logs-container" id="watcher-logs"></div>
    </div>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
// ==================== DEBUG UTILITIES ====================

let debugEnabled = false;
const debugLines = [];
const MAX_DEBUG_LINES = 50;

function debugLog(message, type = 'info') {
  console.log(`[${type.toUpperCase()}]`, message);
  
  if (debugEnabled) {
    const line = document.createElement('div');
    line.className = 'debug-line';
    if (type === 'error') line.classList.add('debug-error');
    if (type === 'warning') line.classList.add('debug-warning');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    
    const console = document.getElementById('debug-console');
    console.insertBefore(line, console.firstChild);
    
    debugLines.push(line);
    if (debugLines.length > MAX_DEBUG_LINES) {
      const removed = debugLines.shift();
      removed.remove();
    }
  }
}

function toggleDebug() {
  debugEnabled = !debugEnabled;
  const console = document.getElementById('debug-console');
  console.classList.toggle('active', debugEnabled);
  debugLog('Debug console ' + (debugEnabled ? 'enabled' : 'disabled'));
}

document.getElementById('debug-toggle').addEventListener('click', toggleDebug);

// Keyboard shortcut: Ctrl+D or Cmd+D
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
    e.preventDefault();
    toggleDebug();
  }
});

// ==================== WATCHER LOGS ====================

const watcherLogs = [];
const MAX_LOG_ENTRIES = 100;
let logsPaused = false;

function addWatcherLog(level, message) {
  if (logsPaused) return;
  
  const timestamp = new Date().toLocaleTimeString();
  const entry = { timestamp, level, message };
  watcherLogs.unshift(entry);
  
  if (watcherLogs.length > MAX_LOG_ENTRIES) {
    watcherLogs.pop();
  }
  
  renderWatcherLogs();
}

function renderWatcherLogs() {
  const container = document.getElementById('watcher-logs');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (watcherLogs.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'log-empty';
    empty.textContent = 'No activity yet...';
    container.appendChild(empty);
    return;
  }
  
  watcherLogs.forEach(entry => {
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    
    const timestamp = document.createElement('span');
    timestamp.className = 'log-timestamp';
    timestamp.textContent = entry.timestamp;
    
    const level = document.createElement('span');
    level.className = `log-level ${entry.level}`;
    level.textContent = entry.level;
    
    const message = document.createElement('span');
    message.className = 'log-message';
    message.textContent = entry.message;
    
    logEntry.appendChild(timestamp);
    logEntry.appendChild(level);
    logEntry.appendChild(message);
    container.appendChild(logEntry);
  });
  
  // Auto-scroll to bottom (most recent)
  if (!logsPaused) {
    container.scrollTop = 0;
  }
}

function clearWatcherLogs() {
  watcherLogs.length = 0;
  renderWatcherLogs();
}

function toggleLogsPause() {
  logsPaused = !logsPaused;
  const btn = document.getElementById('pause-logs-btn');
  btn.textContent = logsPaused ? 'Resume' : 'Pause';
}

// ==================== WATCHER STATUS POLLING ====================

async function updateWatcherStatus() {
  try {
    const res = await fetch('/api/watcher/status');
    if (!res.ok) return;
    
    const data = await res.json();
    
    document.getElementById('inbox-queue-count').textContent = data.inbox_queue || 0;
    document.getElementById('library-queue-count').textContent = data.library_queue || 0;
    document.getElementById('cover-queue-count').textContent = data.cover_queue || 0;
    
    // Add new log entries
    if (data.recent_logs && Array.isArray(data.recent_logs)) {
      data.recent_logs.forEach(log => {
        addWatcherLog(log.level || 'info', log.message || '');
      });
    }
  } catch (e) {
    console.error('Failed to update watcher status:', e);
  }
}

// ==================== UTILITIES ====================

function showLoading() { 
  document.getElementById("loading").style.display = "block"; 
}

function hideLoading() { 
  document.getElementById("loading").style.display = "none"; 
}

function _safe(v) { 
  return (v === undefined || v === null || v === "") ? "0" : String(v); 
}

function fmtTimestamp(epoch) {
  if (!epoch || epoch === 0) return "-";
  const d = new Date(epoch * 1000);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function formatCompactTime(timeStr) {
  if (!timeStr || timeStr === "0 seconds" || timeStr === "-" || timeStr === "0") return "0 hrs";

  const weekMatch = timeStr.match(/(\d+)\s*week/);
  const dayMatch = timeStr.match(/(\d+)\s*day/);
  const hourMatch = timeStr.match(/(\d+)\s*hour/);
  const minMatch = timeStr.match(/(\d+)\s*minute/);
  const secMatch = timeStr.match(/(\d+)\s*second/);

  const weeks = weekMatch ? parseInt(weekMatch[1]) : 0;
  const days = dayMatch ? parseInt(dayMatch[1]) : 0;
  const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
  const minutes = minMatch ? parseInt(minMatch[1]) : 0;
  const seconds = secMatch ? parseInt(secMatch[1]) : 0;

  const totalHours = (weeks*7*24) + (days*24) + hours + (minutes/60) + (seconds/3600);

  if (totalHours >= 24) return (totalHours/24).toFixed(1) + " days";
  if (totalHours >= 1) return totalHours.toFixed(1) + " hrs";
  if (minutes >= 1) return minutes + " min";
  return seconds + " sec";
}

function formatTrackDuration(seconds) {
  if (!seconds && seconds !== 0) return "-";
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}:${String(s).padStart(2, "0")}`;
}

// ==================== FIXED COVER URL LOGIC ====================

function coverUrlFor(album) {
  const folder =
    album?.folder ||
    album?.path ||
    album?.directory ||
    album?.example_path;

  if (!folder) return "/static/placeholder.jpg";

  const clean = folder.replace(/\/$/, "");

  return `/music/library${clean}/cover.jpg`;
}

// ==================== NAVIGATION ====================

const tabs = document.querySelectorAll(".nav-tab");
const pages = { 
  main: document.getElementById("page-main"), 
  albums: document.getElementById("page-albums"),
  watcher: document.getElementById("page-watcher")
};

tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.id === 'debug-toggle') return;
    tabs.forEach(t => t.classList.remove("active"));
    Object.values(pages).forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    pages[tab.dataset.page].classList.add("active");
  });
});

// ==================== GLOBAL STATE ====================

let allAlbums = [];
let filteredAlbums = [];
let filteredSidebarAlbums = [];
const PAGE_SIZE = 25;
let gridItemsToShow = PAGE_SIZE;
let currentSelectedAlbum = null;

// Audio player state
let player = null;
let currentPlaylist = [];
let currentTrackIndex = -1;
let currentAlbumData = null;

// ==================== STATS ====================

async function loadStats() {
  showLoading();
  try {
    const res = await fetch("/api/stats");
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    const statsDiv = document.getElementById("stats");
    statsDiv.innerHTML = "";
    const add = (label, value) => { const d = document.createElement("div"); d.textContent = label + ": " + value; statsDiv.appendChild(d); };
    add("Tracks", data.tracks ?? "0");
    add("Albums", data.albums ?? "0");
    add("Artists", data.album_artists ?? "0");
    add("Total time", data.total_time ?? "0");
    add("Total size", data.total_size ?? "0");
  } catch (e) { 
    console.error("loadStats error", e); 
  }
  finally { hideLoading(); }
}

// ==================== INBOX ====================

async function loadInboxStats() {
  try {
    const res = await fetch("/api/inbox/stats");
    
    if (!res.ok) {
      console.error("Inbox stats fetch failed:", res.status);
      throw new Error("status " + res.status);
    }
    
    const data = await res.json();
    
    const tracks = data.tracks !== undefined && data.tracks !== null ? String(data.tracks) : "0";
    const artists = data.artists !== undefined && data.artists !== null ? String(data.artists) : "0";
    const albums = data.albums !== undefined && data.albums !== null ? String(data.albums) : "0";
    const time = data.total_time || "0 seconds";
    const size = data.total_size || "0 B";
    
    document.getElementById("inbox-tracks").textContent = tracks;
    document.getElementById("inbox-artists").textContent = artists;
    document.getElementById("inbox-albums").textContent = albums;
    document.getElementById("inbox-time").textContent = formatCompactTime(time);
    document.getElementById("inbox-size").textContent = size;
  } catch (err) { 
    console.error("Error loading inbox stats:", err); 
    document.getElementById("inbox-tracks").textContent = "Error";
    document.getElementById("inbox-artists").textContent = "Error";
    document.getElementById("inbox-albums").textContent = "Error";
    document.getElementById("inbox-time").textContent = "Error";
    document.getElementById("inbox-size").textContent = "Error";
  }
}

function renderInboxTree(tree) {
  const container = document.getElementById("inbox-tree");
  container.innerHTML = "";
  if (!tree || Object.keys(tree).length === 0) {
    const p = document.createElement("div"); p.style.color = "#666"; p.textContent = "No inbox folders found.";
    container.appendChild(p); return;
  }
  for (const artist of Object.keys(tree).sort((a,b) => a.localeCompare(b))) {
    const artistDiv = document.createElement("div"); artistDiv.className = "inbox-artist"; artistDiv.textContent = artist;
    const albumList = document.createElement("div"); albumList.className = "inbox-albums";
    (tree[artist] || []).forEach((album) => {
      const albumDiv = document.createElement("div"); albumDiv.className = "inbox-album";
      albumDiv.textContent = "› " + album; albumDiv.title = album;
      albumDiv.onclick = () => loadInboxFolder(artist, album);
      albumList.appendChild(albumDiv);
    });
    container.appendChild(artistDiv); container.appendChild(albumList);
  }
}

async function loadInboxTree() {
  try {
    const res = await fetch("/api/inbox/tree");
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    renderInboxTree(data.folders || data);
  } catch (err) { 
    console.error("Error loading inbox tree:", err); 
    renderInboxTree({}); 
  }
}

async function loadInboxFolder(artist, album) {
  try {
    const url = `/api/inbox/folder?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    renderInboxFiles(artist, album, data.files);
  } catch (err) { console.error("loadInboxFolder:", err); renderInboxFiles(artist, album, []); }
}

function renderInboxFiles(artist, album, files) {
  const container = document.getElementById("inbox-files");
  container.innerHTML = "";
  const title = document.createElement("h3"); title.textContent = `${artist} — ${album}`; container.appendChild(title);
  if (!files || files.length === 0) {
    const p = document.createElement("div"); p.style.color = "#666"; p.textContent = "No files found."; container.appendChild(p); return;
  }
  const list = document.createElement("ul");
  files.forEach(f => { const li = document.createElement("li"); li.textContent = f; list.appendChild(li); });
  container.appendChild(list);
}

// ==================== ALBUMS (MAIN PAGE) ====================

async function loadAlbums() {
  showLoading();
  try {
    const res = await fetch("/data/albums.json");
    if (!res.ok) throw new Error("status " + res.status);
    const data = await res.json();
    
    debugLog(`Loaded ${data.length} albums from albums.json`);
    
    if (data.length > 0) {
      debugLog(`Sample album keys: ${Object.keys(data[0]).join(', ')}`);
      if (data[0].tracks && data[0].tracks.length > 0) {
        debugLog(`Sample track keys: ${Object.keys(data[0].tracks[0]).join(', ')}`);
      }
    }
    
    allAlbums = Array.isArray(data) ? data.sort((a,b) => {
      const aTime = a._mtime || a.mtime || a.added || 0;
      const bTime = b._mtime || b.mtime || b.added || 0;
      return bTime - aTime;
    }) : [];
    filteredAlbums = allAlbums.slice();
    filteredSidebarAlbums = allAlbums.slice();
    gridItemsToShow = PAGE_SIZE;
    renderAlbums();
    renderAlbumGrid();
    renderRecentArtists(allAlbums);
    renderAlbumsSidebar();
  } catch (e) { 
    console.error("loadAlbums error", e);
    debugLog(`Error loading albums: ${e.message}`, 'error');
  }
  finally { hideLoading(); }
}

function renderAlbums() {
  const list = document.getElementById("album-list");
  if (!list) return;
  list.innerHTML = "";
  for (const a of filteredAlbums) {
    const row = document.createElement("div"); row.className = "album-row";
    const title = document.createElement("div"); title.className = "album-title"; title.textContent = a.album || "(Unknown album)";
    const meta = document.createElement("div"); meta.className = "album-meta";
    const bits = [];
    if (a.albumartist) bits.push(a.albumartist); else if (a.artist) bits.push(a.artist);
    if (a.year) bits.push(a.year);
    meta.textContent = bits.join(" • ") || "-";
    row.appendChild(title); row.appendChild(meta); list.appendChild(row);
  }
}

function renderAlbumGrid() {
  const grid = document.getElementById("album-grid");
  if (!grid) return;
  grid.innerHTML = "";
  const albums = filteredAlbums;
  const itemsToDisplay = Math.min(gridItemsToShow, albums.length);
  albums.slice(0, itemsToDisplay).forEach((a) => {
    const item = document.createElement("div"); item.className = "album-grid-item";
    const coverDiv = document.createElement("div"); coverDiv.className = "album-grid-cover";
    const img = document.createElement("img"); img.src = coverUrlFor(a);
    img.onerror = () => { img.onerror = null; img.src = "/static/placeholder.jpg"; };
    coverDiv.appendChild(img);
    const title = document.createElement("div"); title.className = "album-grid-title"; title.textContent = a.album || "(Unknown album)";
    const meta = document.createElement("div"); meta.className = "album-grid-meta";
    const bits = [];
    if (a.albumartist) bits.push(a.albumartist); else if (a.artist) bits.push(a.artist);
    if (a.year) bits.push(a.year);
    meta.textContent = bits.join(" • ") || "-";
    item.appendChild(coverDiv); item.appendChild(title); item.appendChild(meta); grid.appendChild(item);
  });
  const pageInfo = document.getElementById("grid-page-info");
  if (pageInfo) pageInfo.textContent = `Showing ${itemsToDisplay} of ${albums.length}`;
  const btn = document.getElementById("grid-load-more");
  if (btn) { btn.disabled = itemsToDisplay >= albums.length; btn.textContent = btn.disabled ? "All Loaded" : "Load More"; }

  requestAnimationFrame(() => {
    const gridBox = document.querySelector(".album-grid-box");
    const container = document.querySelector(".bottom-container");
    if (gridBox && container) {
      container.style.gridTemplateRows = gridBox.getBoundingClientRect().height + "px";
    }
  });
}

function filterAlbums() {
  const q = (document.getElementById("search")?.value || "").toLowerCase().trim();
  filteredAlbums = q ? allAlbums.filter(a => ((a.album||"") + " " + (a.albumartist||a.artist||"")).toLowerCase().includes(q)) : allAlbums.slice();
  gridItemsToShow = PAGE_SIZE;
  renderAlbums();
  renderAlbumGrid();
}

function renderRecentArtists(albums) {
  const recentArtists = []; const seen = new Set();
  for (const a of albums) {
    const name = a.albumartist || a.artist || "(Unknown artist)";
    if (!seen.has(name)) { seen.add(name); recentArtists.push(a); if (recentArtists.length >= 40) break; }
  }
  const container = document.getElementById("recent-artists");
  if (!container) return;
  container.innerHTML = "";
  recentArtists.forEach((a) => {
    const row = document.createElement("div"); row.className = "artist-row";
    const img = document.createElement("img"); img.src = coverUrlFor(a);
    img.onerror = () => { img.onerror = null; img.src = "/static/placeholder.jpg"; };
    const textWrap = document.createElement("div");
    const nameDiv = document.createElement("div"); nameDiv.className = "artist-name"; nameDiv.textContent = a.albumartist || a.artist || "";
    const metaDiv = document.createElement("div"); metaDiv.className = "artist-meta"; metaDiv.textContent = (a.year || "");
    textWrap.appendChild(nameDiv); textWrap.appendChild(metaDiv);
    row.appendChild(img); row.appendChild(textWrap); container.appendChild(row);
  });
}

// ==================== ALBUMS PAGE ====================

function renderAlbumsSidebar() {
  const container = document.getElementById("albums-sidebar-list");
  if (!container) return;
  container.innerHTML = "";
  filteredSidebarAlbums.forEach((a, idx) => {
    const item = document.createElement("div");
    item.className = "sidebar-album-item";
    item.dataset.idx = idx;
    item.dataset.originalIdx = allAlbums.indexOf(a);
    item.onclick = () => selectAlbum(allAlbums.indexOf(a));

    const thumb = document.createElement("div"); thumb.className = "sidebar-album-thumb";
    const img = document.createElement("img"); img.src = coverUrlFor(a);
    img.onerror = () => { img.onerror = null; img.src = "/static/placeholder.jpg"; };
    thumb.appendChild(img);

    const info = document.createElement("div"); info.className = "sidebar-album-info";
    const name = document.createElement("div"); name.className = "sidebar-album-name"; name.textContent = a.album || "(Unknown)";
    const artist = document.createElement("div"); artist.className = "sidebar-album-artist"; artist.textContent = a.albumartist || a.artist || "";
    info.appendChild(name); info.appendChild(artist);

    const year = document.createElement("div"); year.className = "sidebar-album-year"; year.textContent = a.year || "";

    item.appendChild(thumb); item.appendChild(info); item.appendChild(year);
    container.appendChild(item);
  });
}

function filterSidebarAlbums() {
  const q = (document.getElementById("albums-search")?.value || "").toLowerCase().trim();
  filteredSidebarAlbums = q 
    ? allAlbums.filter(a => ((a.album||"") + " " + (a.albumartist||a.artist||"")).toLowerCase().includes(q)) 
    : allAlbums.slice();
  renderAlbumsSidebar();
}

function selectAlbum(idx) {
  currentSelectedAlbum = idx;
  document.querySelectorAll(".sidebar-album-item").forEach(el => el.classList.remove("active"));
  const selected = document.querySelector(`.sidebar-album-item[data-original-idx="${idx}"]`);
  if (selected) selected.classList.add("active");
  renderAlbumDetail(allAlbums[idx]);
}

function renderAlbumDetail(album) {
  const panel = document.getElementById("albums-detail-panel");
  
  if (!album) {
    panel.innerHTML = "";
    const empty = document.createElement("div");
    empty.className = "albums-detail-empty";
    empty.innerHTML = '<div class="empty-icon">??</div><div>Select an album to view its tracks</div>';
    panel.appendChild(empty);
    return;
  }

  debugLog(`Rendering album: ${album.album}`);
  debugLog(`Album path/folder: ${album.path || album.folder || album.directory || 'NONE'}`);
  debugLog(`Tracks count: ${album.tracks?.length || 0}`);

  const tracks = album.tracks || [];
  let totalSeconds = 0;
  tracks.forEach(t => { totalSeconds += (t.length || 0); });

  panel.innerHTML = "";

  const header = document.createElement("div"); header.className = "albums-detail-header";
  const coverWrap = document.createElement("div"); coverWrap.className = "albums-detail-cover";
  const coverImg = document.createElement("img"); coverImg.src = coverUrlFor(album);
  coverImg.onerror = () => { coverImg.onerror = null; coverImg.src = "/static/placeholder.jpg"; };
  coverWrap.appendChild(coverImg);

  const info = document.createElement("div"); info.className = "albums-detail-info";
  const titleEl = document.createElement("div"); titleEl.className = "albums-detail-title"; titleEl.textContent = album.album || "(Unknown album)";
  const artistEl = document.createElement("div"); artistEl.className = "albums-detail-artist"; artistEl.textContent = album.albumartist || album.artist || "";
  const metaParts = [];
  if (album.year) metaParts.push(album.year);
  if (tracks.length) metaParts.push(tracks.length + " tracks");
  if (totalSeconds > 0) metaParts.push(formatCompactTime(totalSeconds + " seconds"));
  const metaEl = document.createElement("div"); metaEl.className = "albums-detail-meta"; metaEl.textContent = metaParts.join(" • ");
  info.appendChild(titleEl); info.appendChild(artistEl); info.appendChild(metaEl);
  header.appendChild(coverWrap); header.appendChild(info);
  panel.appendChild(header);

  const trackContainer = document.createElement("div"); trackContainer.className = "tracklist-container";

  if (tracks.length === 0) {
    const empty = document.createElement("div");
    empty.style.cssText = "padding: 32px 16px; color: #666; font-size: 13px; text-align: center;";
    empty.textContent = "No track data available for this album.";
    trackContainer.appendChild(empty);
  } else {
    const table = document.createElement("table"); table.className = "tracklist-table";
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    ["#", "Title", "Artist", "Duration"].forEach(h => {
      const th = document.createElement("th"); th.textContent = h; headerRow.appendChild(th);
    });
    thead.appendChild(headerRow); table.appendChild(thead);

    const tbody = document.createElement("tbody");
    tracks.forEach((t, i) => {
      const tr = document.createElement("tr");
      tr.dataset.trackIndex = i;
      
      tr.onclick = () => playTrack(album, i);
      
      const numTd = document.createElement("td"); numTd.className = "track-num"; numTd.textContent = (t.track || (i+1));
      const titleTd = document.createElement("td"); titleTd.className = "track-title"; titleTd.textContent = t.title || "(Untitled)";
      const artistTd = document.createElement("td"); artistTd.textContent = t.artist || album.albumartist || album.artist || "";
      const durTd = document.createElement("td"); durTd.className = "track-duration"; durTd.textContent = formatTrackDuration(t.length);
      tr.appendChild(numTd); tr.appendChild(titleTd); tr.appendChild(artistTd); tr.appendChild(durTd);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    trackContainer.appendChild(table);
  }
  panel.appendChild(trackContainer);

  const playerBox = document.createElement("div");
  playerBox.className = "audio-player-box";
  playerBox.id = "audio-player-box";
  
  const playerTitle = document.createElement("h3");
  playerTitle.textContent = "Now Playing";
  playerBox.appendChild(playerTitle);

  const nowPlayingInfo = document.createElement("div");
  nowPlayingInfo.className = "now-playing-info";
  nowPlayingInfo.id = "now-playing-info";
  nowPlayingInfo.innerHTML = '<div class="audio-player-empty">Click a track to start playing</div>';
  playerBox.appendChild(nowPlayingInfo);

  const audioEl = document.createElement("audio");
  audioEl.id = "audio-player";
  audioEl.controls = true;
  playerBox.appendChild(audioEl);

  panel.appendChild(playerBox);

  initializePlayer();
  
  currentAlbumData = album;
  currentPlaylist = tracks;
}

// ==================== AUDIO PLAYER ====================

function initializePlayer() {
  const audioEl = document.getElementById("audio-player");
  if (!audioEl) return;

  if (player) {
    player.destroy();
  }

  player = new Plyr(audioEl, {
    controls: [
      'play-large',
      'play',
      'progress',
      'current-time',
      'duration',
      'mute',
      'volume',
      'settings',
      'download'
    ],
    settings: ['speed', 'loop'],
    speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
    keyboard: { focused: true, global: true }
  });

  player.on('ended', () => {
    playNextTrack();
  });

  player.on('error', (event) => {
    debugLog(`Player error: ${JSON.stringify(event)}`, 'error');
  });
}

function getTrackPath(album, track) {
  debugLog(`Getting track path for: ${track.title}`);
  debugLog(`Track object: ${JSON.stringify(track, null, 2)}`);
  debugLog(`Album object keys: ${Object.keys(album).join(', ')}`);
  
  let trackPath = track.path || track.file || track.filename || track._path;
  
  debugLog(`Track path field: ${trackPath || 'NONE'}`);
  
  if (trackPath && trackPath.startsWith('/')) {
    if (trackPath.startsWith('/music/library')) {
      debugLog(`Using full track path (already prefixed): ${trackPath}`);
      return trackPath;
    } else {
      const fullPath = `/music/library${trackPath}`;
      debugLog(`Using full track path: ${fullPath}`);
      return fullPath;
    }
  }
  
  const albumFolder = album.path || album.folder || album.directory || album.example_path || album._path;
  debugLog(`Album folder: ${albumFolder || 'NONE'}`);
  
  if (albumFolder && trackPath) {
    const cleanFolder = albumFolder.replace(/\/$/, '');
    const cleanTrack = trackPath.replace(/^\//, '');
    const fullPath = `/music/library${cleanFolder}/${cleanTrack}`;
    debugLog(`Built path: ${fullPath}`);
    return fullPath;
  }
  
  if (albumFolder && track.title) {
    const extensions = ['.flac', '.mp3', '.m4a', '.ogg', '.wav', '.opus'];
    for (const ext of extensions) {
      const possiblePath = `/music/library${albumFolder}/${track.title}${ext}`;
      debugLog(`Trying extension guess: ${possiblePath}`, 'warning');
      return possiblePath;
    }
  }
  
  debugLog('Could not determine track path!', 'error');
  return null;
}

function playTrack(album, trackIndex) {
  const track = album.tracks[trackIndex];
  if (!track) {
    debugLog('Track not found at index ' + trackIndex, 'error');
    return;
  }

  debugLog(`=== PLAYING TRACK ${trackIndex} ===`);
  const trackPath = getTrackPath(album, track);
  
  if (!trackPath) {
    debugLog("Could not determine track path", 'error');
    alert('Cannot play this track - path could not be determined. Check debug console for details.');
    return;
  }

  debugLog(`Final track path: ${trackPath}`);
  
  currentTrackIndex = trackIndex;
  currentAlbumData = album;
  currentPlaylist = album.tracks;

  if (player) {
    const mimeType = getAudioMimeType(trackPath);
    debugLog(`MIME type: ${mimeType}`);
    
    player.source = {
      type: 'audio',
      sources: [
        {
          src: trackPath,
          type: mimeType
        }
      ]
    };
    
    player.play().then(() => {
      debugLog('Playback started successfully');
    }).catch((error) => {
      debugLog(`Playback failed: ${error.message}`, 'error');
      alert(`Failed to play track. Check debug console.\nPath: ${trackPath}\nError: ${error.message}`);
    });
  } else {
    debugLog('Player not initialized', 'error');
    debugLog('Attempting to reinitialize player...', 'warning');
    initializePlayer();
    setTimeout(() => playTrack(album, trackIndex), 100);
  }

  updateNowPlayingInfo(album, track);
  
  updateTrackHighlight(trackIndex);
}

function getAudioMimeType(path) {
  const ext = path.split('.').pop().toLowerCase();
  const mimeTypes = {
    'flac': 'audio/flac',
    'mp3': 'audio/mpeg',
    'wav': 'audio/wav',
    'ogg': 'audio/ogg',
    'opus': 'audio/opus',
    'm4a': 'audio/mp4',
    'aac': 'audio/aac',
    'weba': 'audio/webm'
  };
  return mimeTypes[ext] || 'audio/mpeg';
}

function updateNowPlayingInfo(album, track) {
  const infoDiv = document.getElementById("now-playing-info");
  if (!infoDiv) return;

  infoDiv.innerHTML = "";

  const coverDiv = document.createElement("div");
  coverDiv.className = "now-playing-cover";
  const coverImg = document.createElement("img");
  coverImg.src = coverUrlFor(album);
  coverImg.onerror = () => { coverImg.onerror = null; coverImg.src = "/static/placeholder.jpg"; };
  coverDiv.appendChild(coverImg);

  const textDiv = document.createElement("div");
  textDiv.className = "now-playing-text";

  const trackTitle = document.createElement("div");
  trackTitle.className = "now-playing-track";
  trackTitle.textContent = track.title || "(Untitled)";

  const artistName = document.createElement("div");
  artistName.className = "now-playing-artist";
  artistName.textContent = track.artist || album.albumartist || album.artist || "";

  const albumName = document.createElement("div");
  albumName.className = "now-playing-album";
  albumName.textContent = album.album || "";

  textDiv.appendChild(trackTitle);
  textDiv.appendChild(artistName);
  textDiv.appendChild(albumName);

  infoDiv.appendChild(coverDiv);
  infoDiv.appendChild(textDiv);
}

function updateTrackHighlight(trackIndex) {
  document.querySelectorAll(".tracklist-table tbody tr").forEach(tr => {
    tr.classList.remove("playing");
  });

  const currentRow = document.querySelector(`.tracklist-table tbody tr[data-track-index="${trackIndex}"]`);
  if (currentRow) {
    currentRow.classList.add("playing");
  }
}

function playNextTrack() {
  if (!currentPlaylist || currentPlaylist.length === 0) return;
  
  const nextIndex = currentTrackIndex + 1;
  if (nextIndex < currentPlaylist.length) {
    playTrack(currentAlbumData, nextIndex);
  }
}

function playPreviousTrack() {
  if (!currentPlaylist || currentPlaylist.length === 0) return;
  
  const prevIndex = currentTrackIndex - 1;
  if (prevIndex >= 0) {
    playTrack(currentAlbumData, prevIndex);
  }
}

// ==================== INIT ====================

document.addEventListener("DOMContentLoaded", () => {
  loadStats();
  loadInboxStats();
  loadInboxTree();
  loadAlbums();

  document.getElementById("grid-load-more").onclick = () => { gridItemsToShow += PAGE_SIZE; renderAlbumGrid(); };
  document.getElementById("search").addEventListener("input", filterAlbums);
  document.getElementById("albums-search").addEventListener("input", filterSidebarAlbums);
  document.getElementById("clear-logs-btn").onclick = clearWatcherLogs;
  document.getElementById("pause-logs-btn").onclick = toggleLogsPause;

  // Poll watcher status every 2 seconds
  setInterval(updateWatcherStatus, 2000);

  setInterval(() => { 
    loadStats(); 
    loadInboxStats(); 
    loadInboxTree(); 
  }, 60000);
});
</script>
</body>
</html>
